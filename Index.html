<div class="summary-card">
                            <h3>Pa√≠ses √önicos</h3>
                            <div class="summary-value" id="total-countries">0</div>
                            <div class="summary-label">pa√≠ses comercio</div>
                        </div>
                    </div>

                    <div class="export-section">
                        <h3>üéØ Generar Archivos AEAT</h3>
                        <p>Descarga los archivos CSV listos para subir a la AEAT</p>
                        
                        <div style="margin-top: 20px;">
                            <button class="btn btn-success btn-large" id="download-exports" onclick="downloadExports()" disabled>
                                üì§ Descargar Exportaciones AEAT
                            </button>
                            <button class="btn btn-success btn-large" id="download-imports" onclick="downloadImports()" disabled>
                                üì• Descargar Importaciones AEAT
                            </button>
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <button class="btn btn-large" onclick="downloadConsolidatedReport()" disabled id="download-report">
                                üìã Descargar Informe Consolidado
                            </button>
                        </div>
                    </div>

                    <div id="country-breakdown-section" style="display: none;">
                        <h3>Desglose por Pa√≠ses:</h3>
                        <div id="country-breakdown" class="country-breakdown"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales ampliadas
        let exportData = [];
        let importData = [];
        let processedFiles = [];
        let currentTab = 'monthly-manager';
        
        // Sistema de gesti√≥n por meses
        let monthlyData = {
            currentMonth: '06',
            currentYear: '2025',
            folders: {}
        };

        // Inicializar la aplicaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            initializeMonthlySystem();
            logMessage('Sistema inicializado. Listo para procesar archivos de Alstom.');
            // Mostrar informaci√≥n de deployment
            updateDeploymentInfo();
        });

        function setupEventListeners() {
            // Procesador r√°pido (legacy)
            document.getElementById('main-files').addEventListener('change', handleFileSelect);
            
            // Gesti√≥n por meses
            document.getElementById('export-files').addEventListener('change', (e) => handleClassifiedFileSelect(e, 'export'));
            document.getElementById('import-files').addEventListener('change', (e) => handleClassifiedFileSelect(e, 'import'));
            
            // Drag and drop para procesador r√°pido
            const uploadArea = document.getElementById('main-upload');
            if (uploadArea) {
                uploadArea.addEventListener('drop', handleDrop);
                uploadArea.addEventListener('dragover', handleDragOver);
                uploadArea.addEventListener('dragleave', handleDragLeave);
            }
        }

        function initializeMonthlySystem() {
            loadMonthData();
            updateFolderDisplay();
        }

        function loadMonthData() {
            const month = document.getElementById('month-select').value;
            const year = document.getElementById('year-select').value;
            
            monthlyData.currentMonth = month;
            monthlyData.currentYear = year;
            
            const monthNames = {
                '01': 'Enero', '02': 'Febrero', '03': 'Marzo', '04': 'Abril',
                '05': 'Mayo', '06': 'Junio', '07': 'Julio', '08': 'Agosto',
                '09': 'Septiembre', '10': 'Octubre', '11': 'Noviembre', '12': 'Diciembre'
            };
            
            const monthKey = `${year}-${month}`;
            
            // Inicializar estructura del mes si no existe
            if (!monthlyData.folders[monthKey]) {
                monthlyData.folders[monthKey] = {
                    exports: [],
                    imports: []
                };
            }
            
            // Actualizar display
            document.getElementById('current-month-display').innerHTML = 
                `<strong>üìÅ Trabajando en: ${monthNames[month]} ${year}</strong>`;
            document.getElementById('folder-title').textContent = `${monthNames[month]} ${year}`;
            
            updateFolderDisplay();
            monthLogMessage(`üìÅ Cargado per√≠odo: ${monthNames[month]} ${year}`);
        }

        function handleClassifiedFileSelect(event, type) {
            const files = event.target.files;
            if (files.length > 0) {
                addFilesToMonth(files, type);
            }
        }

        function handleClassifiedDrop(event, type) {
            event.preventDefault();
            event.currentTarget.classList.remove('dragover');
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                addFilesToMonth(files, type);
            }
        }

        async function addFilesToMonth(files, type) {
            const monthKey = `${monthlyData.currentYear}-${monthlyData.currentMonth}`;
            const typeKey = type + 's'; // 'export' -> 'exports', 'import' -> 'imports'
            
            monthLogMessage(`üìÅ Agregando ${files.length} archivo(s) a ${type === 'export' ? 'Exportaciones' : 'Importaciones'}...`);
            
            for (let file of files) {
                // Leer contenido del archivo para guardarlo
                const fileData = await readFileAsDataURL(file);
                
                const fileInfo = {
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    uploadedAt: new Date(),
                    content: fileData,
                    classification: type
                };
                
                monthlyData.folders[monthKey][typeKey].push(fileInfo);
                monthLogMessage(`‚úÖ Agregado: ${file.name} (${(file.size/1024).toFixed(1)} KB)`);
            }
            
            updateFolderDisplay();
            
            // Limpiar inputs
            document.getElementById('export-files').value = '';
            document.getElementById('import-files').value = '';
        }

        function readFileAsDataURL(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function updateFolderDisplay() {
            const monthKey = `${monthlyData.currentYear}-${monthlyData.currentMonth}`;
            const monthData = monthlyData.folders[monthKey] || { exports: [], imports: [] };
            
            // Actualizar contadores
            document.getElementById('export-count').textContent = `${monthData.exports.length} archivo${monthData.exports.length !== 1 ? 's' : ''}`;
            document.getElementById('import-count').textContent = `${monthData.imports.length} archivo${monthData.imports.length !== 1 ? 's' : ''}`;
            
            // Actualizar listas de archivos
            updateFileList('export-files-list', monthData.exports, 'export');
            updateFileList('import-files-list', monthData.imports, 'import');
            
            // Habilitar bot√≥n de procesamiento si hay archivos
            const hasFiles = monthData.exports.length > 0 || monthData.imports.length > 0;
            document.getElementById('process-month-btn').disabled = !hasFiles;
        }

        function updateFileList(containerId, files, type) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            files.forEach((file, index) => {
                const fileElement = document.createElement('div');
                fileElement.style.cssText = 'display: flex; align-items: center; padding: 5px; margin: 2px 0; background: white; border-radius: 5px; font-size: 0.85em;';
                
                const iconColor = type === 'export' ? '#27ae60' : '#e74c3c';
                
                fileElement.innerHTML = `
                    <span style="color: ${iconColor};">üìÑ</span>
                    <span style="margin-left: 8px; flex: 1;">${file.name}</span>
                    <span style="color: #666; font-size: 0.8em;">${(file.size/1024).toFixed(1)} KB</span>
                    <button onclick="removeFileFromMonth('${type}', ${index})" style="margin-left: 8px; background: #e74c3c; color: white; border: none; border-radius: 3px; padding: 2px 6px; cursor: pointer; font-size: 0.7em;">‚úï</button>
                `;
                
                container.appendChild(fileElement);
            });
            
            if (files.length === 0) {
                container.innerHTML = '<div style="color: #999; font-style: italic; padding: 10px;">No hay archivos</div>';
            }
        }

        function removeFileFromMonth(type, index) {
            const monthKey = `${monthlyData.currentYear}-${monthlyData.currentMonth}`;
            const typeKey = type + 's';
            
            const fileName = monthlyData.folders[monthKey][typeKey][index].name;
            monthlyData.folders[monthKey][typeKey].splice(index, 1);
            
            monthLogMessage(`üóëÔ∏è Eliminado: ${fileName}`);
            updateFolderDisplay();
        }

        async function processCurrentMonth() {
            const monthKey = `${monthlyData.currentYear}-${monthlyData.currentMonth}`;
            const monthData = monthlyData.folders[monthKey];
            
            if (!monthData || (monthData.exports.length === 0 && monthData.imports.length === 0)) {
                alert('No hay archivos para procesar en este mes.');
                return;
            }
            
            showMonthProgress();
            monthLogMessage('üöÄ Iniciando procesamiento del mes completo...');
            
            // Limpiar datos anteriores
            exportData = [];
            importData = [];
            processedFiles = [];
            
            let totalFiles = monthData.exports.length + monthData.imports.length;
            let processedCount = 0;
            
            // Procesar exportaciones
            for (let fileInfo of monthData.exports) {
                try {
                    monthLogMessage(`üì§ Procesando exportaci√≥n: ${fileInfo.name}`);
                    updateMonthProgress((processedCount / totalFiles) * 100, `Procesando ${fileInfo.name}...`);
                    
                    const file = await dataURLToFile(fileInfo.content, fileInfo.name, fileInfo.type);
                    const result = await processFile(file);
                    
                    if (result) {
                        // Forzar clasificaci√≥n como exportaci√≥n
                        result.type = 'export';
                        result.monthSource = `${monthlyData.currentYear}-${monthlyData.currentMonth}`;
                        
                        processedFiles.push({
                            name: fileInfo.name,
                            size: fileInfo.size,
                            type: 'export',
                            recordCount: result.recordCount,
                            processedAt: new Date(),
                            monthSource: result.monthSource
                        });
                        
                        exportData = exportData.concat(result.data);
                        monthLogMessage(`‚úÖ ${fileInfo.name}: ${result.recordCount} registros como exportaci√≥n`);
                    }
                } catch (error) {
                    monthLogMessage(`‚ùå Error procesando ${fileInfo.name}: ${error.message}`);
                }
                processedCount++;
            }
            
            // Procesar importaciones
            for (let fileInfo of monthData.imports) {
                try {
                    monthLogMessage(`üì• Procesando importaci√≥n: ${fileInfo.name}`);
                    updateMonthProgress((processedCount / totalFiles) * 100, `Procesando ${fileInfo.name}...`);
                    
                    const file = await dataURLToFile(fileInfo.content, fileInfo.name, fileInfo.type);
                    const result = await processFile(file);
                    
                    if (result) {
                        // Forzar clasificaci√≥n como importaci√≥n
                        result.type = 'import';
                        result.monthSource = `${monthlyData.currentYear}-${monthlyData.currentMonth}`;
                        
                        processedFiles.push({
                            name: fileInfo.name,
                            size: fileInfo.size,
                            type: 'import',
                            recordCount: result.recordCount,
                            processedAt: new Date(),
                            monthSource: result.monthSource
                        });
                        
                        importData = importData.concat(result.data);
                        monthLogMessage(`‚úÖ ${fileInfo.name}: ${result.recordCount} registros como importaci√≥n`);
                    }
                } catch (error) {
                    monthLogMessage(`‚ùå Error procesando ${fileInfo.name}: ${error.message}`);
                }
                processedCount++;
            }
            
            updateMonthProgress(100, 'Procesamiento del mes completado');
            updateSummaries();
            showProcessedFiles();
            enableDownloads();
            
            monthLogMessage(`üéâ Mes procesado completamente. Total: ${exportData.length} exportaciones, ${importData.length} importaciones`);
            
            // Cambiar a pesta√±a de resumen
            switchTab('summary');
        }

        function dataURLToFile(dataURL, filename, mimeType) {
            return new Promise((resolve) => {
                const byteString = atob(dataURL.split(',')[1]);
                const arrayBuffer = new ArrayBuffer(byteString.length);
                const uint8Array = new Uint8Array(arrayBuffer);
                
                for (let i = 0; i < byteString.length; i++) {
                    uint8Array[i] = byteString.charCodeAt(i);
                }
                
                const blob = new Blob([uint8Array], { type: mimeType });
                const file = new File([blob], filename, { type: mimeType });
                resolve(file);
            });
        }

        function showMonthProgress() {
            document.getElementById('month-progress-section').style.display = 'block';
            document.getElementById('month-log-section').style.display = 'block';
        }

        function updateMonthProgress(percentage, message) {
            document.getElementById('month-progress-fill').style.width = percentage + '%';
            document.getElementById('month-progress-text').textContent = message;
        }

        function monthLogMessage(message) {
            const logArea = document.getElementById('month-log-area');
            const timestamp = new Date().toLocaleTimeString();
            logArea.innerHTML += `[${timestamp}] ${message}\n`;
            logArea.scrollTop = logArea.scrollHeight;
            
            // Tambi√©n enviarlo al log principal para backward compatibility
            logMessage(message);
        }

        function switchTab(tabName) {
            // Ocultar todas las pesta√±as
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Ocultar todos los botones de pesta√±a
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Mostrar la pesta√±a seleccionada
            document.getElementById(tabName).classList.add('active');
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            
            currentTab = tabName;
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            const files = e.dataTransfer.files;
            processFiles(files);
        }

        function handleFileSelect(e) {
            const files = e.target.files;
            processFiles(files);
        }

        async function processFiles(files) {
            if (files.length === 0) return;

            showProgress();
            logMessage(`Iniciando procesamiento de ${files.length} archivo(s)...`);

            let totalFiles = files.length;
            let processedCount = 0;

            for (let file of files) {
                try {
                    logMessage(`Procesando: ${file.name}`);
                    updateProgress((processedCount / totalFiles) * 100, `Procesando ${file.name}...`);

                    const result = await processFile(file);
                    if (result) {
                        processedFiles.push({
                            name: file.name,
                            size: file.size,
                            type: result.type,
                            recordCount: result.recordCount,
                            processedAt: new Date()
                        });
                        
                        if (result.type === 'export') {
                            exportData = exportData.concat(result.data);
                        } else if (result.type === 'import') {
                            importData = importData.concat(result.data);
                        }
                        
                        logMessage(`‚úÖ ${file.name}: ${result.recordCount} registros procesados como ${result.type}`);
                    }
                } catch (error) {
                    logMessage(`‚ùå Error procesando ${file.name}: ${error.message}`);
                }
                
                processedCount++;
            }

            updateProgress(100, 'Procesamiento completado');
            updateSummaries();
            showProcessedFiles();
            enableDownloads();
            
            logMessage(`üéâ Procesamiento completado. Total: ${exportData.length} exportaciones, ${importData.length} importaciones`);
        }

        async function processFile(file) {
            const fileName = file.name.toLowerCase();
            
            if (fileName.endsWith('.csv')) {
                return await processCSVFile(file);
            } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                return await processExcelFile(file);
            } else {
                throw new Error('Formato de archivo no soportado');
            }
        }

        async function processCSVFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const text = e.target.result;
                        const lines = text.split('\n').filter(line => line.trim());
                        
                        // Detectar si es un archivo ya procesado (formato AEAT) o raw
                        const firstLine = lines[0];
                        const isAEATFormat = firstLine.split(';').length >= 14;
                        
                        let data = [];
                        let type = 'unknown';
                        
                        if (isAEATFormat) {
                            // Ya est√° en formato AEAT, solo clasificar
                            data = lines.map((line, index) => {
                                const fields = line.split(';');
                                return mapAEATFields(fields, index, file.name);
                            }).filter(item => item !== null);
                            
                            type = determineTradeType(data);
                        } else {
                            // Formato raw de Alstom, necesita procesamiento
                            data = processRawCSVData(lines, file.name);
                            type = determineTradeType(data);
                        }
                        
                        resolve({
                            type: type,
                            data: data,
                            recordCount: data.length
                        });
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = () => reject(new Error('Error leyendo archivo CSV'));
                reader.readAsText(file);
            });
        }

        // Funci√≥n para determinar tipo de comercio - DEBE IR ANTES DE processExcelFile
        function determineTradeType(data) {
            if (data.length === 0) return 'unknown';
            
            // Contar exportaciones vs importaciones
            let exportCount = 0;
            let importCount = 0;
            
            data.forEach(item => {
                if (item && item.paisOrigen === 'ES' && item.estadoMiembro !== 'ES') {
                    exportCount++;
                } else if (item && item.paisOrigen !== 'ES' && item.estadoMiembro !== 'ES') {
                    importCount++;
                }
            });
            
            console.log(`Debug: exportCount=${exportCount}, importCount=${importCount}, total=${data.length}`);
            
            // Si m√°s del 50% son exportaciones, clasificar como export
            return exportCount > importCount ? 'export' : 'import';
        }

        async function processExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        // Procesar la primera hoja
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                        
                        // Procesar datos bas√°ndose en la estructura detectada
                        const processedData = processExcelData(jsonData, file.name);
                        const type = determineTradeType(processedData);
                        
                        resolve({
                            type: type,
                            data: processedData,
                            recordCount: processedData.length
                        });
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = () => reject(new Error('Error leyendo archivo Excel'));
                reader.readAsArrayBuffer(file);
            });
        }

        function processExcelData(jsonData, fileName) {
            // Filtrar filas vac√≠as y encontrar la fila de cabeceras
            const nonEmptyRows = jsonData.filter(row => row && row.some(cell => cell !== null && cell !== undefined && cell !== ''));
            
            if (nonEmptyRows.length === 0) return [];
            
            // Para el formato espec√≠fico de Alstom, los datos empiezan en la fila 1
            // Fila 0 = cabeceras: FACTURA|FECHA|ART|REF|DESC|CANT|IMPORTE|PESO_UD|peso|PESO_TOTAL|HS_CODE|INCOTERM|TRANSPORTE|PAIS_ORIGEN|NIF_VIES|PAIS_ENTREGA
            const dataRows = nonEmptyRows.slice(1);
            
            return dataRows.map((row, index) => {
                return mapExcelRowToIntrastat(row, index, fileName);
            }).filter(item => item !== null);
        }

        // FUNCI√ìN CORREGIDA PARA MAPEO DE EXCEL A INTRASTAT
        function mapExcelRowToIntrastat(row, index, fileName) {
            // Si la fila est√° vac√≠a o no tiene suficientes datos, saltarla
            if (!row || row.length < 15) return null;
            
            // Mapeo espec√≠fico para el formato de Alstom Intrastat
            // Basado en la estructura: FACTURA|FECHA|ART|REF|DESC|CANT|IMPORTE|PESO_UD|peso|PESO_TOTAL|HS_CODE|INCOTERM|TRANSPORTE|PAIS_ORIGEN|NIF_VIES|PAIS_ENTREGA
            
            const estadoMiembro = getCountryCode(row[15]); // PA√çS ENTREGA
            const paisOrigen = getCountryCode(row[13]);    // PA√çS ORIGEN MERCANC√çA
            const codMercancia = cleanHSCode(row[10]);     // HS CODE
            const importeFactura = parseFloat(row[6]) || 0; // BASE IMP (mantener signo original)
            const masaNeta = Math.abs(parseFloat(row[9]) || 0);       // PESO TOTAL (valor absoluto)
            const nifContraparte = row[14] ? row[14].toString().trim() : ''; // NIF VIES
            
            // Validar que tenemos datos m√≠nimos requeridos
            if (!estadoMiembro || !codMercancia || importeFactura === 0) {
                return null;
            }
            
            // Determinar si es exportaci√≥n o importaci√≥n
            // Si el pa√≠s de entrega es diferente a Espa√±a y el origen es Espa√±a -> Exportaci√≥n
            // Si el pa√≠s de origen es diferente a Espa√±a -> Importaci√≥n
            const isExport = (paisOrigen === 'ES' || paisOrigen === '') && estadoMiembro !== 'ES';
            
            return {
                estadoMiembro: estadoMiembro,
                provincia: '48', // Bizkaia por defecto para Alstom
                condEntrega: row[11] ? row[11].toString().trim() : 'FCA',
                natTrans: '11', // Compra/venta definitiva
                modoTransporte: getModoTransporte(row[12]), // Mapear modo de transporte
                puerto: '', // Vac√≠o por defecto
                codMercancia: codMercancia,
                paisOrigen: paisOrigen || 'ES', // Si no hay pa√≠s origen, asumir Espa√±a
                regEstadistico: '1',
                masaNeta: masaNeta,
                unidSuplementaria: 0,
                importeFactura: importeFactura,
                valorEstadistico: importeFactura, // Mismo valor que factura
                nifContraparte: nifContraparte,
                origen: fileName,
                lineaOriginal: index + 1,
                tipoOperacion: isExport ? 'export' : 'import' // Para debugging
            };
        }

        function getCountryCode(countryName) {
            if (!countryName) return '';
            
            const name = countryName.toString().toLowerCase().trim();
            
            // Mapeo de nombres de pa√≠ses a c√≥digos ISO
            const countryMap = {
                'francia': 'FR',
                'france': 'FR',
                'alemania': 'DE',
                'germany': 'DE',
                'deutschland': 'DE',
                'estonia': 'EE',
                'lituania': 'LT',
                'lithuania': 'LT',
                'italia': 'IT',
                'italy': 'IT',
                'pa√≠ses bajos': 'NL',
                'netherlands': 'NL',
                'holanda': 'NL',
                'b√©lgica': 'BE',
                'belgium': 'BE',
                'portugal': 'PT',
                'hungr√≠a': 'HU',
                'hungary': 'HU',
                'polonia': 'PL',
                'poland': 'PL',
                'suecia': 'SE',
                'sweden': 'SE',
                'dinamarca': 'DK',
                'denmark': 'DK',
                'finlandia': 'FI',
                'finland': 'FI',
                'austria': 'AT',
                'rep√∫blica checa': 'CZ',
                'czech republic': 'CZ',
                'eslovaquia': 'SK',
                'slovakia': 'SK',
                'eslovenia': 'SI',
                'slovenia': 'SI',
                'croacia': 'HR',
                'croatia': 'HR',
                'bulgaria': 'BG',
                'ruman√≠a': 'RO',
                'romania': 'RO',
                'espa√±a': 'ES',
                'spain': 'ES'
            };
            
            return countryMap[name] || '';
        }

        function cleanHSCode(code) {
            if (!code) return '';
            
            // Limpiar c√≥digo HS: quitar puntos, espacios y normalizar
            return code.toString()
                .replace(/\./g, '') // Quitar puntos
                .replace(/\s/g, '') // Quitar espacios
                .padEnd(8, '0')     // Asegurar 8 d√≠gitos
                .substring(0, 8);   // M√°ximo 8 d√≠gitos
        }

        function getModoTransporte(transporte) {
            if (!transporte) return '3'; // Carretera por defecto
            
            const modo = transporte.toString().toLowerCase();
            
            const transporteMap = {
                'carretera': '3',
                'road': '3',
                'mar√≠timo': '1',
                'sea': '1',
                'ferrocarril': '2',
                'rail': '2',
                'a√©reo': '4',
                'air': '4',
                'correos': '5',
                'mail': '5'
            };
            
            return transporteMap[modo] || '3'; // Carretera por defecto
        }

        function mapAEATFields(fields, index, fileName) {
            if (fields.length < 14) return null;
            
            return {
                estadoMiembro: fields[0] || '',
                provincia: fields[1] || '48',
                condEntrega: fields[2] || 'FCA',
                natTrans: fields[3] || '11',
                modoTransporte: fields[4] || '3',
                puerto: fields[5] || '',
                codMercancia: fields[6] || '',
                paisOrigen: fields[7] || '',
                regEstadistico: fields[8] || '1',
                masaNeta: parseFloat(fields[9]) || 0,
                unidSuplementaria: parseFloat(fields[10]) || 0,
                importeFactura: parseFloat(fields[11]) || 0,
                valorEstadistico: parseFloat(fields[12]) || 0,
                nifContraparte: fields[13] || '',
                origen: fileName,
                lineaOriginal: index + 1
            };
        }

        function processRawCSVData(lines, fileName) {
            return lines.map((line, index) => {
                const fields = line.split(';');
                if (fields.length < 5) return null;
                
                return mapExcelRowToIntrastat(fields, index, fileName);
            }).filter(item => item !== null);
        }

        function updateSummaries() {
            updateExportSummary();
            updateImportSummary();
            updateFinalSummary();
        }

        function updateExportSummary() {
            if (exportData.length === 0) return;
            
            const totalRecords = exportData.length;
            const totalValue = exportData.reduce((sum, item) => sum + item.importeFactura, 0);
            const totalWeight = exportData.reduce((sum, item) => sum + item.masaNeta, 0);
            const countries = [...new Set(exportData.map(item => item.estadoMiembro))];
            
            document.getElementById('export-total-records').textContent = totalRecords.toLocaleString();
            document.getElementById('export-total-value').textContent = `‚Ç¨${totalValue.toLocaleString('es-ES', {minimumFractionDigits: 2})}`;
            document.getElementById('export-countries').textContent = countries.length;
            document.getElementById('export-total-weight').textContent = `${totalWeight.toLocaleString('es-ES', {minimumFractionDigits: 0})} kg`;
            
            // Mostrar tabla de datos
            showExportData();
        }

        function updateImportSummary() {
            if (importData.length === 0) return;
            
            const totalRecords = importData.length;
            const totalValue = importData.reduce((sum, item) => sum + item.importeFactura, 0);
            const totalWeight = importData.reduce((sum, item) => sum + item.masaNeta, 0);
            const countries = [...new Set(importData.map(item => item.estadoMiembro))];
            
            document.getElementById('import-total-records').textContent = totalRecords.toLocaleString();
            document.getElementById('import-total-value').textContent = `‚Ç¨${totalValue.toLocaleString('es-ES', {minimumFractionDigits: 2})}`;
            document.getElementById('import-countries').textContent = countries.length;
            document.getElementById('import-total-weight').textContent = `${totalWeight.toLocaleString('es-ES', {minimumFractionDigits: 0})} kg`;
            
            // Mostrar tabla de datos
            showImportData();
        }

        function updateFinalSummary() {
            const totalRecords = exportData.length + importData.length;
            const totalValue = exportData.reduce((sum, item) => sum + item.importeFactura, 0) + 
                              importData.reduce((sum, item) => sum + item.importeFactura, 0);
            const totalFiles = processedFiles.length;
            const allCountries = [...new Set([
                ...exportData.map(item => item.estadoMiembro),
                ...importData.map(item => item.estadoMiembro)
            ])];
            
            document.getElementById('total-records').textContent = totalRecords.toLocaleString();
            document.getElementById('total-trade-value').textContent = `‚Ç¨${totalValue.toLocaleString('es-ES', {minimumFractionDigits: 2})}`;
            document.getElementById('total-files').textContent = totalFiles;
            document.getElementById('total-countries').textContent = allCountries.length;
            
            // Mostrar desglose por pa√≠ses
            showCountryBreakdown(allCountries);
        }

        function showExportData() {
            const table = document.getElementById('export-data-table').getElementsByTagName('tbody')[0];
            table.innerHTML = '';
            
            const dataToShow = exportData.slice(0, 100); // Primeros 100 registros
            
            dataToShow.forEach(item => {
                const row = table.insertRow();
                row.innerHTML = `
                    <td>${item.estadoMiembro}</td>
                    <td>${item.provincia}</td>
                    <td>${item.condEntrega}</td>
                    <td>${item.natTrans}</td>
                    <td>${item.modoTransporte}</td>
                    <td>${item.puerto}</td>
                    <td>${item.codMercancia}</td>
                    <td>${item.paisOrigen}</td>
                    <td>${item.regEstadistico}</td>
                    <td>${item.masaNeta.toLocaleString('es-ES', {minimumFractionDigits: 3})}</td>
                    <td>${item.unidSuplementaria.toLocaleString('es-ES', {minimumFractionDigits: 3})}</td>
                    <td>‚Ç¨${item.importeFactura.toLocaleString('es-ES', {minimumFractionDigits: 2})}</td>
                    <td>‚Ç¨${item.valorEstadistico.toLocaleString('es-ES', {minimumFractionDigits: 2})}</td>
                    <td>${item.nifContraparte}</td>
                    <td>${item.origen}</td>
                `;
            });
            
            document.getElementById('export-data-section').style.display = 'block';
        }

        function showImportData() {
            const table = document.getElementById('import-data-table').getElementsByTagName('tbody')[0];
            table.innerHTML = '';
            
            const dataToShow = importData.slice(0, 100); // Primeros 100 registros
            
            dataToShow.forEach(item => {
                const row = table.insertRow();
                row.innerHTML = `
                    <td>${item.estadoMiembro}</td>
                    <td>${item.provincia}</td>
                    <td>${item.condEntrega}</td>
                    <td>${item.natTrans}</td>
                    <td>${item.modoTransporte}</td>
                    <td>${item.puerto}</td>
                    <td>${item.codMercancia}</td>
                    <td>${item.paisOrigen}</td>
                    <td>${item.regEstadistico}</td>
                    <td>${item.masaNeta.toLocaleString('es-ES', {minimumFractionDigits: 3})}</td>
                    <td>${item.unidSuplementaria.toLocaleString('es-ES', {minimumFractionDigits: 3})}</td>
                    <td>‚Ç¨${item.importeFactura.toLocaleString('es-ES', {minimumFractionDigits: 2})}</td>
                    <td>‚Ç¨${item.valorEstadistico.toLocaleString('es-ES', {minimumFractionDigits: 2})}</td>
                    <td>${item.nifContraparte}</td>
                    <td>${item.origen}</td>
                `;
            });
            
            document.getElementById('import-data-section').style.display = 'block';
        }

        function showCountryBreakdown(countries) {
            const container = document.getElementById('country-breakdown');
            container.innerHTML = '';
            
            countries.forEach(country => {
                const exportCount = exportData.filter(item => item.estadoMiembro === country).length;
                const importCount = importData.filter(item => item.estadoMiembro === country).length;
                const exportValue = exportData.filter(item => item.estadoMiembro === country)
                    .reduce((sum, item) => sum + item.importeFactura, 0);
                const importValue = importData.filter(item => item.estadoMiembro === country)
                    .reduce((sum, item) => sum + item.importeFactura, 0);
                
                const card = document.createElement('div');
                card.className = 'country-card';
                card.innerHTML = `
                    <div class="country-flag">${getCountryFlag(country)}</div>
                    <h4>${country}</h4>
                    <p><strong>Exportaciones:</strong> ${exportCount} (‚Ç¨${exportValue.toLocaleString('es-ES')})</p>
                    <p><strong>Importaciones:</strong> ${importCount} (‚Ç¨${importValue.toLocaleString('es-ES')})</p>
                `;
                container.appendChild(card);
            });
            
            document.getElementById('country-breakdown-section').style.display = 'block';
        }

        function getCountryFlag(countryCode) {
            const flags = {
                'FR': 'üá´üá∑', 'DE': 'üá©üá™', 'IT': 'üáÆüáπ', 'ES': 'üá™üá∏', 'NL': 'üá≥üá±',
                'BE': 'üáßüá™', 'PT': 'üáµüáπ', 'HU': 'üá≠üá∫', 'PL': 'üáµüá±', 'SE': 'üá∏üá™',
                'DK': 'üá©üá∞', 'FI': 'üá´üáÆ', 'AT': 'üá¶üáπ', 'CZ': 'üá®üáø', 'SK': 'üá∏üá∞',
                'SI': 'üá∏üáÆ', 'HR': 'üá≠üá∑', 'BG': 'üáßüá¨', 'RO': 'üá∑üá¥', 'EE': 'üá™üá™',
                'LV': 'üá±üáª', 'LT': 'üá±üáπ', 'CY': 'üá®üáæ', 'MT': 'üá≤üáπ', 'LU': 'üá±üá∫',
                'IE': 'üáÆüá™', 'CH': 'üá®üá≠', 'NO': 'üá≥üá¥', 'CN': 'üá®üá≥'
            };
            return flags[countryCode] || 'üè≥Ô∏è';
        }

        function showProcessedFiles() {
            const container = document.getElementById('processed-files-container');
            container.innerHTML = '';
            
            processedFiles.forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <div class="file-info">
                        <div class="file-name">${file.name}</div>
                        <div class="file-details">
                            ${(file.size / 1024).toFixed(1)} KB ‚Ä¢ 
                            ${file.recordCount} registros ‚Ä¢ 
                            Tipo: ${file.type === 'export' ? 'Exportaci√≥n' : 'Importaci√≥n'} ‚Ä¢ 
                            ${file.processedAt.toLocaleString()}
                        </div>
                    </div>
                    <div>
                        <span style="color: #27ae60; font-weight: bold;">‚úÖ Procesado</span>
                    </div>
                `;
                container.appendChild(fileItem);
            });
            
            document.getElementById('processed-files').style.display = 'block';
        }

        function showProgress() {
            document.getElementById('progress-section').style.display = 'block';
            document.getElementById('log-section').style.display = 'block';
        }

        function updateProgress(percentage, message) {
            document.getElementById('progress-fill').style.width = percentage + '%';
            document.getElementById('progress-text').textContent = message;
        }

        function logMessage(message) {
            const logArea = document.getElementById('log-area');
            const timestamp = new Date().toLocaleTimeString();
            logArea.innerHTML += `[${timestamp}] ${message}\n`;
            logArea.scrollTop = logArea.scrollHeight;
        }

        function enableDownloads() {
            document.getElementById('download-exports').disabled = exportData.length === 0;
            document.getElementById('download-imports').disabled = importData.length === 0;
            document.getElementById('download-report').disabled = exportData.length === 0 && importData.length === 0;
        }

        function downloadExports() {
            if (exportData.length === 0) {
                alert('No hay datos de exportaci√≥n para descargar');
                return;
            }
            
            const csvContent = generateAEATCSV(exportData);
            downloadFile(csvContent, 'Intrastat_Exportaciones_AEAT.csv', 'text/csv');
            logMessage(`üì• Descargado archivo de exportaciones: ${exportData.length} registros`);
        }

        function downloadImports() {
            if (importData.length === 0) {
                alert('No hay datos de importaci√≥n para descargar');
                return;
            }
            
            const csvContent = generateAEATCSV(importData);
            downloadFile(csvContent, 'Intrastat_Importaciones_AEAT.csv', 'text/csv');
            logMessage(`üì• Descargado archivo de importaciones: ${importData.length} registros`);
        }

        function downloadConsolidatedReport() {
            const report = generateConsolidatedReport();
            downloadFile(report, 'Informe_Intrastat_Consolidado.txt', 'text/plain');
            logMessage('üì• Descargado informe consolidado');
        }

        function generateAEATCSV(data) {
            // Formato AEAT: Estado miembro;Provincia;Condiciones de entrega;Naturaleza de la Transacci√≥n;Modalidad de Transporte;Puerto;C√≥digo de las mercancias;Pa√≠s de Origen;R√©gimen estad√≠stico;Masa Neta;Unidades Suplementarias;Importe Facturado;Valor Estad√≠stico;NIF IVA
            
            return data.map(item => {
                return [
                    item.estadoMiembro,
                    item.provincia,
                    item.condEntrega,
                    item.natTrans,
                    item.modoTransporte,
                    item.puerto,
                    item.codMercancia,
                    item.paisOrigen,
                    item.regEstadistico,
                    item.masaNeta.toFixed(3).replace('.', ','),
                    item.unidSuplementaria.toFixed(3).replace('.', ','),
                    item.importeFactura.toFixed(2).replace('.', ','),
                    item.valorEstadistico.toFixed(2).replace('.', ','),
                    item.nifContraparte
                ].join(';');
            }).join('\n');
        }

        function generateConsolidatedReport() {
            const now = new Date();
            const monthNames = {
                '01': 'Enero', '02': 'Febrero', '03': 'Marzo', '04': 'Abril',
                '05': 'Mayo', '06': 'Junio', '07': 'Julio', '08': 'Agosto',
                '09': 'Septiembre', '10': 'Octubre', '11': 'Noviembre', '12': 'Diciembre'
            };
            
            const currentMonthName = monthNames[monthlyData.currentMonth];
            
            // Crear mapa de archivos por tipo para trazabilidad
            const exportFiles = processedFiles.filter(f => f.type === 'export');
            const importFiles = processedFiles.filter(f => f.type === 'import');
            
            let report = `
INFORME CONSOLIDADO INTRASTAT - ALSTOM MOVILIDAD
Per√≠odo: ${currentMonthName} ${monthlyData.currentYear}
Generado: ${now.toLocaleString()}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

RESUMEN GENERAL:
- Total de registros procesados: ${exportData.length + importData.length}
- Archivos procesados: ${processedFiles.length}
- Valor total del comercio: ‚Ç¨${(exportData.reduce((sum, item) => sum + item.importeFactura, 0) + importData.reduce((sum, item) => sum + item.importeFactura, 0)).toLocaleString('es-ES', {minimumFractionDigits: 2})}

EXPORTACIONES (EXPEDICIONES):
- N√∫mero de registros: ${exportData.length}
- Valor total: ‚Ç¨${exportData.reduce((sum, item) => sum + item.importeFactura, 0).toLocaleString('es-ES', {minimumFractionDigits: 2})}
- Masa neta total: ${exportData.reduce((sum, item) => sum + item.masaNeta, 0).toLocaleString('es-ES')} kg
- Pa√≠ses destino: ${[...new Set(exportData.map(item => item.estadoMiembro))].join(', ')}

ARCHIVOS FUENTE - EXPORTACIONES:
${exportFiles.map(file => `- ${file.name} (${file.recordCount} registros)`).join('\n')}

IMPORTACIONES:
- N√∫mero de registros: ${importData.length}
- Valor total: ‚Ç¨${importData.reduce((sum, item) => sum + item.importeFactura, 0).toLocaleString('es-ES', {minimumFractionDigits: 2})}
- Masa neta total: ${importData.reduce((sum, item) => sum + item.masaNeta, 0).toLocaleString('es-ES')} kg
- Pa√≠ses origen: ${[...new Set(importData.map(item => item.estadoMiembro))].join(', ')}

ARCHIVOS FUENTE - IMPORTACIONES:
${importFiles.map(file => `- ${file.name} (${file.recordCount} registros)`).join('\n')}

TRAZABILIDAD COMPLETA:
${processedFiles.map(file => {
    const typeLabel = file.type === 'export' ? 'EXPORTACI√ìN' : 'IMPORTACI√ìN';
    return `- [${typeLabel}] ${file.name} ‚Üí ${file.recordCount} registros procesados`;
}).join('\n')}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

ARCHIVOS GENERADOS:
- Intrastat_Exportaciones_AEAT.csv (${exportData.length} registros)
- Intrastat_Importaciones_AEAT.csv (${importData.length} registros)

NOTA: Los archivos CSV generados est√°n listos para subir directamente a la AEAT.
Formato utilizado: Campos separados por punto y coma (;), decimales con coma (,)

CONTROL DE CALIDAD:
- Todos los registros han sido validados seg√∫n criterios AEAT
- Se mantiene trazabilidad completa hasta el archivo fuente
- Valores negativos preservados para devoluciones/ajustes
- C√≥digos de pa√≠s y mercanc√≠a normalizados
`;
            return report;
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Funci√≥n para mostrar informaci√≥n de deployment
        function updateDeploymentInfo() {
            // Versi√≥n basada en la fecha/hora actual del despliegue
            const deployTime = new Date();
            const version = document.getElementById('app-version').textContent;
            
            // Actualizar tiempo de deployment
            updateDeploymentTime(deployTime);
            
            // Actualizar cada minuto para mostrar "hace X minutos"
            setInterval(() => {
                updateDeploymentTime(deployTime);
            }, 60000); // Cada minuto
            
            // Log de la versi√≥n
            logMessage(`üè∑Ô∏è Aplicaci√≥n iniciada - Versi√≥n ${version} - Deploy: ${deployTime.toLocaleString()}`);
        }

        function updateDeploymentTime(deployTime) {
            const now = new Date();
            const diffMs = now - deployTime;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);
            
            let timeText = '';
            if (diffDays > 0) {
                timeText = `hace ${diffDays} d√≠a${diffDays > 1 ? 's' : ''}`;
            } else if (diffHours > 0) {
                timeText = `hace ${diffHours} hora${diffHours > 1 ? 's' : ''}`;
            } else if (diffMins > 0) {
                timeText = `hace ${diffMins} min`;
            } else {
                timeText = 'reci√©n deployado';
            }
            
            document.getElementById('deployment-time').textContent = timeText;
        }

        // Funci√≥n para actualizar versi√≥n manualmente
        function updateVersion(newVersion) {
            document.getElementById('app-version').textContent = newVersion;
            localStorage.setItem('app-version', newVersion);
        }
    </script>
</body>
</html><!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Intrastat - Alstom Movilidad</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .main-content {
            padding: 40px;
        }

        .section {
            margin-bottom: 40px;
        }

        .section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.8em;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }

        .upload-area {
            border: 3px dashed #3498db;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            background: #f8f9fa;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover {
            background: #e3f2fd;
            border-color: #2196f3;
        }

        .upload-area.dragover {
            background: #e1f5fe;
            border-color: #01579b;
        }

        .upload-icon {
            font-size: 3em;
            color: #3498db;
            margin-bottom: 20px;
        }

        .file-input {
            display: none;
        }

        .btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
            margin: 5px;
            display: inline-block;
            text-decoration: none;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .btn-large {
            padding: 20px 40px;
            font-size: 1.2em;
        }

        .file-list {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: white;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .file-details {
            font-size: 0.9em;
            color: #7f8c8d;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .summary-card {
            background: linear-gradient(135deg, #fff, #f8f9fa);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            border-left: 5px solid #3498db;
        }

        .summary-card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .summary-value {
            font-size: 2em;
            font-weight: bold;
            color: #3498db;
            margin-bottom: 5px;
        }

        .summary-label {
            color: #7f8c8d;
            font-size: 0.9em;
        }

        .tabs {
            display: flex;
            background: #ecf0f1;
            border-radius: 10px;
            padding: 5px;
            margin-bottom: 20px;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .tab.active {
            background: #3498db;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            font-size: 0.9em;
        }

        .data-table th,
        .data-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
        }

        .data-table th {
            background: #2c3e50;
            color: white;
            font-weight: 600;
            font-size: 0.8em;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .alert {
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .export-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin-top: 30px;
            text-align: center;
        }

        .country-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .country-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #e74c3c;
        }

        .progress-section {
            margin: 20px 0;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #ecf0f1;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            width: 0%;
            transition: width 0.5s ease;
        }

        .log-area {
            background: #2c3e50;
            color: #ecf0f1;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 300px;
            overflow-y: auto;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }
            
            .main-content {
                padding: 20px;
            }
            
            .summary-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <!-- Version and Deployment Info -->
            <div style="position: absolute; top: 10px; right: 15px; font-size: 0.8em; color: rgba(255,255,255,0.8); z-index: 1000;">
                <div id="version-info" style="text-align: right; margin-bottom: 5px;">
                    <span style="background: rgba(0,0,0,0.2); padding: 4px 8px; border-radius: 12px; display: inline-block;">
                        üì¶ v<span id="app-version">1.4.0</span>
                    </span>
                </div>
                <div id="deployment-info" style="text-align: right;">
                    <span id="deployment-status" style="background: rgba(0,0,0,0.2); padding: 4px 8px; border-radius: 12px; display: inline-block;">
                        üöÄ <span id="deployment-time">Cargando...</span>
                    </span>
                </div>
            </div>
            <h1>üöÇ Gestor de Intrastat</h1>
            <p>Alstom Movilidad - Procesamiento y Consolidaci√≥n de Datos Intrastat</p>
        </div>

        <div class="main-content">
            <!-- Pesta√±as de navegaci√≥n -->
            <div class="tabs">
                <div class="tab active" onclick="switchTab('monthly-manager')">üìÅ Gesti√≥n por Meses</div>
                <div class="tab" onclick="switchTab('processor')">‚ö° Procesador R√°pido</div>
                <div class="tab" onclick="switchTab('exports')">üì§ Exportaciones</div>
                <div class="tab" onclick="switchTab('imports')">üì• Importaciones</div>
                <div class="tab" onclick="switchTab('summary')">üìä Resumen Final</div>
            </div>

            <!-- Gesti√≥n por Meses -->
            <div id="monthly-manager" class="tab-content active">
                <div class="section">
                    <h2>üìÅ Gesti√≥n de Intrastat por Meses</h2>
                    
                    <div class="alert alert-info">
                        <strong>üéØ Flujo profesional:</strong>
                        <ol style="margin-top: 10px; margin-left: 20px;">
                            <li>Selecciona el mes y a√±o de trabajo</li>
                            <li>Sube archivos clasific√°ndolos como Exportaci√≥n o Importaci√≥n</li>
                            <li>Los archivos se organizan autom√°ticamente por carpetas</li>
                            <li>Procesa el mes completo cuando tengas todos los archivos</li>
                            <li>Genera informes con trazabilidad completa de fuentes</li>
                        </ol>
                    </div>

                    <!-- Selector de Mes/A√±o -->
                    <div class="month-selector" style="background: #f8f9fa; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                        <h3>üìÖ Seleccionar Per√≠odo</h3>
                        <div style="display: flex; gap: 15px; align-items: center; margin-top: 10px;">
                            <label style="font-weight: 600;">Mes:</label>
                            <select id="month-select" style="padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
                                <option value="01">Enero</option>
                                <option value="02">Febrero</option>
                                <option value="03">Marzo</option>
                                <option value="04">Abril</option>
                                <option value="05">Mayo</option>
                                <option value="06" selected>Junio</option>
                                <option value="07">Julio</option>
                                <option value="08">Agosto</option>
                                <option value="09">Septiembre</option>
                                <option value="10">Octubre</option>
                                <option value="11">Noviembre</option>
                                <option value="12">Diciembre</option>
                            </select>
                            
                            <label style="font-weight: 600;">A√±o:</label>
                            <select id="year-select" style="padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
                                <option value="2024">2024</option>
                                <option value="2025" selected>2025</option>
                                <option value="2026">2026</option>
                            </select>
                            
                            <button class="btn" onclick="loadMonthData()" style="margin-left: 10px;">
                                üìÇ Cargar Mes
                            </button>
                        </div>
                        <div id="current-month-display" style="margin-top: 10px; font-size: 1.1em; color: #2c3e50;">
                            <strong>üìÅ Trabajando en: Junio 2025</strong>
                        </div>
                    </div>

                    <!-- √Årea de carga con clasificaci√≥n -->
                    <div class="upload-classification" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <!-- Exportaciones -->
                        <div class="upload-zone export-zone" style="border: 3px dashed #27ae60; border-radius: 15px; padding: 30px; background: #f8fff8; text-align: center; cursor: pointer;" 
                             onclick="document.getElementById('export-files').click()" 
                             ondrop="handleClassifiedDrop(event, 'export')" 
                             ondragover="handleDragOver(event)" 
                             ondragleave="handleDragLeave(event)">
                            <div style="font-size: 2.5em; color: #27ae60; margin-bottom: 15px;">üì§</div>
                            <h3 style="color: #27ae60; margin-bottom: 10px;">EXPORTACIONES</h3>
                            <p>Arrastra archivos de expediciones aqu√≠</p>
                            <p style="font-size: 0.9em; color: #666; margin-top: 10px;">Excel (.xlsx, .xls) y CSV</p>
                            <input type="file" id="export-files" class="file-input" multiple accept=".xlsx,.xls,.csv">
                        </div>

                        <!-- Importaciones -->
                        <div class="upload-zone import-zone" style="border: 3px dashed #e74c3c; border-radius: 15px; padding: 30px; background: #fff8f8; text-align: center; cursor: pointer;" 
                             onclick="document.getElementById('import-files').click()" 
                             ondrop="handleClassifiedDrop(event, 'import')" 
                             ondragover="handleDragOver(event)" 
                             ondragleave="handleDragLeave(event)">
                            <div style="font-size: 2.5em; color: #e74c3c; margin-bottom: 15px;">üì•</div>
                            <h3 style="color: #e74c3c; margin-bottom: 10px;">IMPORTACIONES</h3>
                            <p>Arrastra archivos de adquisiciones aqu√≠</p>
                            <p style="font-size: 0.9em; color: #666; margin-top: 10px;">Excel (.xlsx, .xls) y CSV</p>
                            <input type="file" id="import-files" class="file-input" multiple accept=".xlsx,.xls,.csv">
                        </div>
                    </div>

                    <!-- Estructura de carpetas del mes actual -->
                    <div id="month-structure" class="month-structure" style="background: #f8f9fa; border-radius: 10px; padding: 20px;">
                        <h3>üìÇ Archivos del Mes Actual</h3>
                        <div id="month-folders" style="margin-top: 15px;">
                            <div class="folder-view">
                                <div class="folder-header" style="display: flex; align-items: center; margin-bottom: 15px;">
                                    <span style="font-size: 1.5em;">üìÅ</span>
                                    <span style="font-weight: 600; margin-left: 10px;" id="folder-title">Junio 2025</span>
                                    <button class="btn btn-success" onclick="processCurrentMonth()" disabled id="process-month-btn" style="margin-left: auto;">
                                        ‚ö° Procesar Mes Completo
                                    </button>
                                </div>
                                
                                <!-- Exportaciones folder -->
                                <div class="subfolder" style="margin-left: 20px; margin-bottom: 10px;">
                                    <div style="display: flex; align-items: center; margin-bottom: 5px;">
                                        <span style="font-size: 1.2em;">üì§</span>
                                        <span style="font-weight: 600; margin-left: 8px; color: #27ae60;">Exportaciones</span>
                                        <span id="export-count" style="margin-left: 10px; background: #27ae60; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8em;">0 archivos</span>
                                    </div>
                                    <div id="export-files-list" style="margin-left: 25px;"></div>
                                </div>
                                
                                <!-- Importaciones folder -->
                                <div class="subfolder" style="margin-left: 20px;">
                                    <div style="display: flex; align-items: center; margin-bottom: 5px;">
                                        <span style="font-size: 1.2em;">üì•</span>
                                        <span style="font-weight: 600; margin-left: 8px; color: #e74c3c;">Importaciones</span>
                                        <span id="import-count" style="margin-left: 10px; background: #e74c3c; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8em;">0 archivos</span>
                                    </div>
                                    <div id="import-files-list" style="margin-left: 25px;"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Progreso de procesamiento -->
                    <div id="month-progress-section" class="progress-section" style="display: none;">
                        <h3>Procesando mes completo...</h3>
                        <div class="progress-bar">
                            <div class="progress-fill" id="month-progress-fill"></div>
                        </div>
                        <p id="month-progress-text">Iniciando...</p>
                    </div>

                    <!-- Log espec√≠fico del mes -->
                    <div id="month-log-section" style="display: none;">
                        <h3>Log de Procesamiento del Mes:</h3>
                        <div id="month-log-area" class="log-area"></div>
                    </div>
                </div>
            </div>

            <!-- Procesador R√°pido (anteriormente Procesador) -->
            <div id="processor" class="tab-content">
                <div class="section">
                    <h2>‚ö° Procesador R√°pido</h2>
                    
                    <div class="alert alert-info">
                        <strong>üöÄ Procesamiento inmediato:</strong>
                        <ol style="margin-top: 10px; margin-left: 20px;">
                            <li>Sube archivos para procesamiento inmediato (modo legacy)</li>
                            <li>El sistema los procesar√° y mapear√° al formato AEAT</li>
                            <li>Revisa y valida los datos procesados</li>
                            <li>Descarga el archivo CSV final para AEAT</li>
                        </ol>
                        <p style="margin-top: 10px;"><strong>üí° Recomendaci√≥n:</strong> Usa la "Gesti√≥n por Meses" para un flujo m√°s profesional.</p>
                    </div>

                    <div class="upload-area" id="main-upload" onclick="document.getElementById('main-files').click()" 
                         ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                        <div class="upload-icon">üìÅ</div>
                        <h3>Arrastra archivos Excel/CSV de Alstom aqu√≠</h3>
                        <p>Archivos soportados: .xlsx, .xls, .csv</p>
                        <p><strong>Procesa autom√°ticamente:</strong> Expediciones e Importaciones</p>
                        <input type="file" id="main-files" class="file-input" multiple accept=".xlsx,.xls,.csv">
                    </div>

                    <div id="progress-section" class="progress-section" style="display: none;">
                        <h3>Procesando archivos...</h3>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-fill"></div>
                        </div>
                        <p id="progress-text">Iniciando...</p>
                    </div>

                    <div id="log-section" style="display: none;">
                        <h3>Log de Procesamiento:</h3>
                        <div id="log-area" class="log-area"></div>
                    </div>

                    <div id="processed-files" class="file-list" style="display: none;">
                        <h3>Archivos Procesados:</h3>
                        <div id="processed-files-container"></div>
                    </div>
                </div>
            </div>

            <!-- Contenido de Exportaciones -->
            <div id="exports" class="tab-content">
                <div class="section">
                    <h2>üì§ Exportaciones Procesadas (Expediciones)</h2>
                    
                    <div class="summary-grid" id="export-summary">
                        <div class="summary-card">
                            <h3>Total Registros</h3>
                            <div class="summary-value" id="export-total-records">0</div>
                            <div class="summary-label">expediciones procesadas</div>
                        </div>
                        <div class="summary-card">
                            <h3>Valor Total</h3>
                            <div class="summary-value" id="export-total-value">‚Ç¨0</div>
                            <div class="summary-label">importe facturado</div>
                        </div>
                        <div class="summary-card">
                            <h3>Pa√≠ses Destino</h3>
                            <div class="summary-value" id="export-countries">0</div>
                            <div class="summary-label">pa√≠ses diferentes</div>
                        </div>
                        <div class="summary-card">
                            <h3>Masa Neta Total</h3>
                            <div class="summary-value" id="export-total-weight">0</div>
                            <div class="summary-label">kg exportados</div>
                        </div>
                    </div>

                    <div id="export-data-section" style="display: none;">
                        <h3>Datos de Exportaci√≥n (Primeros 100 registros):</h3>
                        <div style="overflow-x: auto;">
                            <table class="data-table" id="export-data-table">
                                <thead>
                                    <tr>
                                        <th>Pa√≠s</th>
                                        <th>Provincia</th>
                                        <th>Cond. Entrega</th>
                                        <th>Nat. Trans.</th>
                                        <th>Transporte</th>
                                        <th>Puerto</th>
                                        <th>C√≥d. Mercanc√≠a</th>
                                        <th>Pa√≠s Origen</th>
                                        <th>Reg. Est.</th>
                                        <th>Masa Neta</th>
                                        <th>Unid. Supl.</th>
                                        <th>Imp. Facturado</th>
                                        <th>Valor Est.</th>
                                        <th>NIF Contraparte</th>
                                        <th>Origen</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contenido de Importaciones -->
            <div id="imports" class="tab-content">
                <div class="section">
                    <h2>üì• Importaciones Procesadas</h2>
                    
                    <div class="summary-grid" id="import-summary">
                        <div class="summary-card">
                            <h3>Total Registros</h3>
                            <div class="summary-value" id="import-total-records">0</div>
                            <div class="summary-label">importaciones procesadas</div>
                        </div>
                        <div class="summary-card">
                            <h3>Valor Total</h3>
                            <div class="summary-value" id="import-total-value">‚Ç¨0</div>
                            <div class="summary-label">importe facturado</div>
                        </div>
                        <div class="summary-card">
                            <h3>Pa√≠ses Origen</h3>
                            <div class="summary-value" id="import-countries">0</div>
                            <div class="summary-label">pa√≠ses diferentes</div>
                        </div>
                        <div class="summary-card">
                            <h3>Masa Neta Total</h3>
                            <div class="summary-value" id="import-total-weight">0</div>
                            <div class="summary-label">kg importados</div>
                        </div>
                    </div>

                    <div id="import-data-section" style="display: none;">
                        <h3>Datos de Importaci√≥n (Primeros 100 registros):</h3>
                        <div style="overflow-x: auto;">
                            <table class="data-table" id="import-data-table">
                                <thead>
                                    <tr>
                                        <th>Pa√≠s</th>
                                        <th>Provincia</th>
                                        <th>Cond. Entrega</th>
                                        <th>Nat. Trans.</th>
                                        <th>Transporte</th>
                                        <th>Puerto</th>
                                        <th>C√≥d. Mercanc√≠a</th>
                                        <th>Pa√≠s Origen</th>
                                        <th>Reg. Est.</th>
                                        <th>Masa Neta</th>
                                        <th>Unid. Supl.</th>
                                        <th>Imp. Facturado</th>
                                        <th>Valor Est.</th>
                                        <th>NIF Contraparte</th>
                                        <th>Origen</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Resumen Final -->
            <div id="summary" class="tab-content">
                <div class="section">
                    <h2>üìä Resumen Final y Exportaci√≥n</h2>
                    
                    <div class="summary-grid">
                        <div class="summary-card">
                            <h3>Total General</h3>
                            <div class="summary-value" id="total-records">0</div>
                            <div class="summary-label">registros procesados</div>
                        </div>
                        <div class="summary-card">
                            <h3>Valor Comercio</h3>
                            <div class="summary-value" id="total-trade-value">‚Ç¨0</div>
                            <div class="summary-label">valor total comercio</div>
                        </div>
                        <div class="summary-card">
                            <h3>Archivos Origen</h3>
                            <div class="summary-value" id="total-files">0</div>
                            <div class="summary-label">archivos procesados</div>
                        </div>
                        <div class="summary-card">
                            <h3>
