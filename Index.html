<!DOCTYPE html>
<html lang="es">
<head>
    <!-- Test auto-versioning -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Intrastat - Alstom Movilidad</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .main-content {
            padding: 40px;
        }

        .section {
            margin-bottom: 40px;
        }

        .section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.8em;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }

        .upload-area {
            border: 3px dashed #3498db;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            background: #f8f9fa;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover {
            background: #e3f2fd;
            border-color: #2196f3;
        }

        .upload-area.dragover {
            background: #e1f5fe;
            border-color: #01579b;
        }

        .upload-icon {
            font-size: 3em;
            color: #3498db;
            margin-bottom: 20px;
        }

        .file-input {
            display: none;
        }

        .btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
            margin: 5px;
            display: inline-block;
            text-decoration: none;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .btn-large {
            padding: 20px 40px;
            font-size: 1.2em;
        }

        .file-list {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: white;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .file-details {
            font-size: 0.9em;
            color: #7f8c8d;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .summary-card {
            background: linear-gradient(135deg, #fff, #f8f9fa);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            border-left: 5px solid #3498db;
        }

        .summary-card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .summary-value {
            font-size: 2em;
            font-weight: bold;
            color: #3498db;
            margin-bottom: 5px;
        }

        .summary-label {
            color: #7f8c8d;
            font-size: 0.9em;
        }

        .tabs {
            display: flex;
            background: #ecf0f1;
            border-radius: 10px;
            padding: 5px;
            margin-bottom: 20px;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .tab.active {
            background: #3498db;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            font-size: 0.9em;
        }

        .data-table th,
        .data-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
        }

        .data-table th {
            background: #2c3e50;
            color: white;
            font-weight: 600;
            font-size: 0.8em;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .alert {
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .export-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin-top: 30px;
            text-align: center;
        }

        .country-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .country-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #e74c3c;
        }

        .progress-section {
            margin: 20px 0;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #ecf0f1;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            width: 0%;
            transition: width 0.5s ease;
        }

        .log-area {
            background: #2c3e50;
            color: #ecf0f1;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 300px;
            overflow-y: auto;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }
            
            .main-content {
                padding: 20px;
            }
            
            .summary-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <!-- Version and Deployment Info -->
            <div style="position: absolute; top: 10px; right: 15px; font-size: 0.8em; color: rgba(255,255,255,0.8); z-index: 1000;">
                <div id="version-info" style="text-align: right; margin-bottom: 5px;">
                    <span style="background: rgba(0,0,0,0.2); padding: 4px 8px; border-radius: 12px; display: inline-block;">
                        üì¶ v<span id="app-version">1.5.2</span>
                    </span>
                </div>
                <div id="deployment-info" style="text-align: right; margin-bottom: 5px;">
                    <span id="deployment-status" style="background: rgba(0,0,0,0.2); padding: 4px 8px; border-radius: 12px; display: inline-block;">
                        üöÄ <span id="deployment-time">Activo</span>
                    </span>
                </div>
                <div id="railway-info" style="text-align: right;">
                    <span id="railway-status" style="background: rgba(46,204,113,0.2); padding: 4px 8px; border-radius: 12px; display: inline-block; border: 1px solid rgba(46,204,113,0.4);">
                        üöÇ Railway: v<span id="railway-version">1.5.0</span>
                    </span>
                </div>
            </div>
            <h1>üöÇ Gestor de Intrastat</h1>
            <p>Alstom Movilidad - Procesamiento y Consolidaci√≥n de Datos Intrastat</p>
        </div>

        <div class="main-content">
            <!-- Pesta√±as de navegaci√≥n -->
            <div class="tabs">
                <div class="tab active" onclick="console.log('Tab clicked: monthly-manager'); switchTab('monthly-manager')">üìÅ Gesti√≥n por Meses</div>
                <div class="tab" onclick="console.log('Tab clicked: processor'); switchTab('processor')">‚ö° Procesador R√°pido</div>
                <div class="tab" onclick="console.log('Tab clicked: exports'); switchTab('exports')">üì§ Exportaciones</div>
                <div class="tab" onclick="console.log('Tab clicked: imports'); switchTab('imports')">üì• Importaciones</div>
                <div class="tab" onclick="console.log('Tab clicked: summary'); switchTab('summary')">üìä Resumen Final</div>
            </div>

            <!-- Gesti√≥n por Meses -->
            <div id="monthly-manager" class="tab-content active">
                <div class="section">
                    <h2>üìÅ Gesti√≥n de Intrastat por Meses</h2>
                    
                    <div class="alert alert-info">
                        <strong>üéØ Flujo profesional:</strong>
                        <ol style="margin-top: 10px; margin-left: 20px;">
                            <li>Selecciona el mes y a√±o de trabajo</li>
                            <li>Sube archivos clasific√°ndolos como Exportaci√≥n o Importaci√≥n</li>
                            <li>Los archivos se organizan autom√°ticamente por carpetas</li>
                            <li>Procesa el mes completo cuando tengas todos los archivos</li>
                            <li>Genera informes con trazabilidad completa de fuentes</li>
                        </ol>
                    </div>

                    <!-- Selector de Mes/A√±o -->
                    <div class="month-selector" style="background: #f8f9fa; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                        <h3>üìÖ Seleccionar Per√≠odo</h3>
                        <div style="display: flex; gap: 15px; align-items: center; margin-top: 10px;">
                            <label style="font-weight: 600;">Mes:</label>
                            <select id="month-select" style="padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
                                <option value="01">Enero</option>
                                <option value="02">Febrero</option>
                                <option value="03">Marzo</option>
                                <option value="04">Abril</option>
                                <option value="05">Mayo</option>
                                <option value="06" selected>Junio</option>
                                <option value="07">Julio</option>
                                <option value="08">Agosto</option>
                                <option value="09">Septiembre</option>
                                <option value="10">Octubre</option>
                                <option value="11">Noviembre</option>
                                <option value="12">Diciembre</option>
                            </select>
                            
                            <label style="font-weight: 600;">A√±o:</label>
                            <select id="year-select" style="padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
                                <option value="2024">2024</option>
                                <option value="2025" selected>2025</option>
                                <option value="2026">2026</option>
                            </select>
                            
                            <button class="btn" onclick="loadMonthData()" style="margin-left: 10px;">
                                üìÇ Cargar Mes
                            </button>
                        </div>
                        <div id="current-month-display" style="margin-top: 10px; font-size: 1.1em; color: #2c3e50;">
                            <strong>üìÅ Trabajando en: Junio 2025</strong>
                        </div>
                    </div>

                    <!-- √Årea de carga con clasificaci√≥n -->
                    <div class="upload-classification" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <!-- Exportaciones -->
                        <div class="upload-zone export-zone" style="border: 3px dashed #27ae60; border-radius: 15px; padding: 30px; background: #f8fff8; text-align: center; cursor: pointer;" 
                             onclick="console.log('Export zone clicked'); const input = document.getElementById('export-files'); console.log('Input element:', input); if(input) input.click(); else console.error('Export input not found on click');" 
                             ondrop="handleClassifiedDrop(event, 'export')" 
                             ondragover="handleDragOver(event)" 
                             ondragleave="handleDragLeave(event)">
                            <div style="font-size: 2.5em; color: #27ae60; margin-bottom: 15px;">üì§</div>
                            <h3 style="color: #27ae60; margin-bottom: 10px;">EXPORTACIONES</h3>
                            <p>Arrastra archivos de expediciones aqu√≠</p>
                            <p style="font-size: 0.9em; color: #666; margin-top: 10px;">Excel (.xlsx, .xls) y CSV</p>
                            <input type="file" id="export-files" class="file-input" multiple accept=".xlsx,.xls,.csv">
                        </div>

                        <!-- Importaciones -->
                        <div class="upload-zone import-zone" style="border: 3px dashed #e74c3c; border-radius: 15px; padding: 30px; background: #fff8f8; text-align: center; cursor: pointer;" 
                             onclick="document.getElementById('import-files').click()" 
                             ondrop="handleClassifiedDrop(event, 'import')" 
                             ondragover="handleDragOver(event)" 
                             ondragleave="handleDragLeave(event)">
                            <div style="font-size: 2.5em; color: #e74c3c; margin-bottom: 15px;">üì•</div>
                            <h3 style="color: #e74c3c; margin-bottom: 10px;">IMPORTACIONES</h3>
                            <p>Arrastra archivos de adquisiciones aqu√≠</p>
                            <p style="font-size: 0.9em; color: #666; margin-top: 10px;">Excel (.xlsx, .xls) y CSV</p>
                            <input type="file" id="import-files" class="file-input" multiple accept=".xlsx,.xls,.csv">
                        </div>
                    </div>

                    <!-- Estructura de carpetas del mes actual -->
                    <div id="month-structure" class="month-structure" style="background: #f8f9fa; border-radius: 10px; padding: 20px;">
                        <h3>üìÇ Archivos del Mes Actual</h3>
                        <div id="month-folders" style="margin-top: 15px;">
                            <div class="folder-view">
                                <div class="folder-header" style="display: flex; align-items: center; margin-bottom: 15px;">
                                    <span style="font-size: 1.5em;">üìÅ</span>
                                    <span style="font-weight: 600; margin-left: 10px;" id="folder-title">Junio 2025</span>
                                    <button class="btn btn-success" onclick="processCurrentMonth()" disabled id="process-month-btn" style="margin-left: auto;">
                                        ‚ö° Procesar Mes Completo
                                    </button>
                                </div>
                                
                                <!-- Exportaciones folder -->
                                <div class="subfolder" style="margin-left: 20px; margin-bottom: 10px;">
                                    <div style="display: flex; align-items: center; margin-bottom: 5px;">
                                        <span style="font-size: 1.2em;">üì§</span>
                                        <span style="font-weight: 600; margin-left: 8px; color: #27ae60;">Exportaciones</span>
                                        <span id="export-count" style="margin-left: 10px; background: #27ae60; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8em;">0 archivos</span>
                                    </div>
                                    <div id="export-files-list" style="margin-left: 25px;"></div>
                                </div>
                                
                                <!-- Importaciones folder -->
                                <div class="subfolder" style="margin-left: 20px;">
                                    <div style="display: flex; align-items: center; margin-bottom: 5px;">
                                        <span style="font-size: 1.2em;">üì•</span>
                                        <span style="font-weight: 600; margin-left: 8px; color: #e74c3c;">Importaciones</span>
                                        <span id="import-count" style="margin-left: 10px; background: #e74c3c; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8em;">0 archivos</span>
                                    </div>
                                    <div id="import-files-list" style="margin-left: 25px;"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Progreso de procesamiento -->
                    <div id="month-progress-section" class="progress-section" style="display: none;">
                        <h3>Procesando mes completo...</h3>
                        <div class="progress-bar">
                            <div class="progress-fill" id="month-progress-fill"></div>
                        </div>
                        <p id="month-progress-text">Iniciando...</p>
                    </div>

                    <!-- Log espec√≠fico del mes -->
                    <div id="month-log-section" style="display: none;">
                        <h3>Log de Procesamiento del Mes:</h3>
                        <div id="month-log-area" class="log-area"></div>
                    </div>
                </div>
            </div>

            <!-- Procesador R√°pido (Legacy) -->
            <div id="processor" class="tab-content">
                <div class="section">
                    <h2>‚ö° Procesador R√°pido</h2>
                    <div class="alert alert-info">
                        <strong>üí° Modo r√°pido para casos urgentes:</strong> Sube archivos sin clasificar para procesamiento inmediato. Para flujos organizados usa "Gesti√≥n por Meses".
                    </div>
                    
                    <div class="upload-area" onclick="document.getElementById('fileInput').click()" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                        <div class="upload-icon">üìÅ</div>
                        <h3>Selecciona o arrastra archivos aqu√≠</h3>
                        <p>Formatos soportados: Excel (.xlsx, .xls) y CSV</p>
                        <input type="file" id="fileInput" class="file-input" multiple accept=".xlsx,.xls,.csv">
                    </div>

                    <div id="fileList" class="file-list" style="display: none;">
                        <h3>Archivos cargados:</h3>
                        <div id="fileItems"></div>
                        <button class="btn btn-large" onclick="processFiles()">üöÄ Procesar Archivos</button>
                    </div>

                    <div id="progressSection" class="progress-section" style="display: none;">
                        <h3>Procesando archivos...</h3>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <p id="progressText">Iniciando...</p>
                    </div>

                    <div id="logSection" style="display: none;">
                        <h3>Log de procesamiento:</h3>
                        <div id="logArea" class="log-area"></div>
                    </div>
                </div>
            </div>

            <!-- Exportaciones -->
            <div id="exports" class="tab-content">
                <div class="section">
                    <h2>üì§ Exportaciones</h2>
                    <div id="exportData">
                        <p>No se han procesado exportaciones a√∫n.</p>
                    </div>
                </div>
            </div>

            <!-- Importaciones -->
            <div id="imports" class="tab-content">
                <div class="section">
                    <h2>üì• Importaciones</h2>
                    <div id="importData">
                        <p>No se han procesado importaciones a√∫n.</p>
                    </div>
                </div>
            </div>

            <!-- Resumen Final -->
            <div id="summary" class="tab-content">
                <div class="section">
                    <h2>üìä Resumen Final</h2>
                    <div id="summaryContent">
                        <p>Procesa archivos para ver el resumen completo.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Gesti√≥n de pesta√±as - DEFINIR PRIMERO
        function switchTab(tabName) {
            try {
                console.log('switchTab called with:', tabName);
                
                // Ocultar todas las pesta√±as
                const tabs = document.querySelectorAll('.tab');
                const contents = document.querySelectorAll('.tab-content');
                
                tabs.forEach(tab => tab.classList.remove('active'));
                contents.forEach(content => content.classList.remove('active'));
                
                // Mostrar la pesta√±a seleccionada
                const targetTab = document.querySelector(`[onclick*="${tabName}"]`);
                if (targetTab) {
                    targetTab.classList.add('active');
                }
                
                const targetContent = document.getElementById(tabName);
                if (targetContent) {
                    targetContent.classList.add('active');
                    console.log('Tab switched successfully to:', tabName);
                } else {
                    console.error('Tab content not found:', tabName);
                }
            } catch (error) {
                console.error('Error in switchTab:', error);
            }
        }

        // Variables globales
        let processedData = {
            exports: [],
            imports: [],
            consolidatedExports: [],
            consolidatedImports: []
        };

        let currentMonth = {
            month: '06',
            year: '2025',
            files: {
                exports: [],
                imports: []
            }
        };

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            updateDeploymentInfo();
            loadMonthData();
            
            // Event listeners para archivos clasificados
            const exportInput = document.getElementById('export-files');
            const importInput = document.getElementById('import-files');
            
            console.log('Setting up file input listeners:', exportInput, importInput);
            
            if (exportInput) {
                exportInput.addEventListener('change', function(e) {
                    console.log('Export files input changed:', e.target.files);
                    handleClassifiedFiles(e.target.files, 'export');
                });
                console.log('Export listener added successfully');
            } else {
                console.error('Export files input not found!');
            }
            
            if (importInput) {
                importInput.addEventListener('change', function(e) {
                    console.log('Import files input changed:', e.target.files);
                    handleClassifiedFiles(e.target.files, 'import');
                });
                console.log('Import listener added successfully');
            } else {
                console.error('Import files input not found!');
            }
            
            // Event listener para procesador r√°pido
            document.getElementById('fileInput').addEventListener('change', function(e) {
                handleFiles(e.target.files);
            });
        });

        // Funciones de actualizaci√≥n de informaci√≥n
        function updateDeploymentInfo() {
            try {
                const now = new Date();
                const deploymentTime = now.toLocaleString('es-ES', {
                    day: '2-digit',
                    month: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                const element = document.getElementById('deployment-time');
                if (element) {
                    element.textContent = deploymentTime;
                }
                
                // Actualizar informaci√≥n de Railway
                updateRailwayStatus();
            } catch (error) {
                console.log('Error updating deployment info:', error);
            }
        }
        
        function updateRailwayStatus() {
            try {
                // Obtener versi√≥n actual del DOM
                const currentVersion = document.getElementById('app-version').textContent;
                const railwayVersionElement = document.getElementById('railway-version');
                const railwayStatusElement = document.getElementById('railway-status');
                
                if (railwayVersionElement) {
                    railwayVersionElement.textContent = currentVersion;
                }
                
                // Generar timestamp √∫nico para detectar despliegue
                const deploymentId = new Date().getTime().toString().slice(-6);
                
                // Indicar que es la versi√≥n actualmente desplegada
                if (railwayStatusElement) {
                    railwayStatusElement.style.background = 'rgba(46,204,113,0.3)';
                    railwayStatusElement.style.border = '1px solid rgba(46,204,113,0.6)';
                    railwayStatusElement.innerHTML = `üöÇ Railway: v${currentVersion} <small>(#${deploymentId})</small>`;
                }
                
                console.log('Railway status updated:', currentVersion, deploymentId);
            } catch (error) {
                console.log('Error updating Railway status:', error);
            }
        }


        // Gesti√≥n de meses
        function loadMonthData() {
            const monthSelect = document.getElementById('month-select');
            const yearSelect = document.getElementById('year-select');
            
            currentMonth.month = monthSelect.value;
            currentMonth.year = yearSelect.value;
            
            const monthNames = {
                '01': 'Enero', '02': 'Febrero', '03': 'Marzo', '04': 'Abril',
                '05': 'Mayo', '06': 'Junio', '07': 'Julio', '08': 'Agosto',
                '09': 'Septiembre', '10': 'Octubre', '11': 'Noviembre', '12': 'Diciembre'
            };
            
            const monthName = monthNames[currentMonth.month];
            const displayText = `üìÅ Trabajando en: ${monthName} ${currentMonth.year}`;
            
            document.getElementById('current-month-display').innerHTML = `<strong>${displayText}</strong>`;
            document.getElementById('folder-title').textContent = `${monthName} ${currentMonth.year}`;
            
            updateMonthStructure();
        }

        function updateMonthStructure() {
            const exportCount = currentMonth.files.exports.length;
            const importCount = currentMonth.files.imports.length;
            
            document.getElementById('export-count').textContent = `${exportCount} archivos`;
            document.getElementById('import-count').textContent = `${importCount} archivos`;
            
            // Actualizar listas de archivos
            updateFilesList('export-files-list', currentMonth.files.exports, 'export');
            updateFilesList('import-files-list', currentMonth.files.imports, 'import');
            
            // Habilitar/deshabilitar bot√≥n de procesamiento
            const processBtn = document.getElementById('process-month-btn');
            processBtn.disabled = (exportCount === 0 && importCount === 0);
        }

        function updateFilesList(containerId, files, type) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            files.forEach((file, index) => {
                const fileElement = document.createElement('div');
                fileElement.style.cssText = 'display: flex; align-items: center; justify-content: space-between; padding: 8px; background: white; margin-bottom: 5px; border-radius: 5px; font-size: 0.9em;';
                
                fileElement.innerHTML = `
                    <span>üìÑ ${file.name}</span>
                    <button class="btn btn-danger" style="padding: 4px 8px; font-size: 0.8em;" onclick="removeMonthFile('${type}', ${index})">
                        ‚ùå Quitar
                    </button>
                `;
                
                container.appendChild(fileElement);
            });
        }

        function removeMonthFile(type, index) {
            currentMonth.files[type + 's'].splice(index, 1);
            updateMonthStructure();
        }

        // Gesti√≥n de archivos clasificados
        function handleClassifiedFiles(files, type) {
            console.log('üî• handleClassifiedFiles called with:', files ? files.length : 'null', 'files, type:', type);
            
            if (!files || files.length === 0) {
                console.log('‚ùå No files provided');
                alert('No se seleccionaron archivos');
                return;
            }
            
            let validFiles = 0;
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                console.log('üìÑ Processing file:', file.name, 'type:', file.type, 'size:', file.size);
                
                // Validaci√≥n m√°s simple
                const isValid = file.name.endsWith('.xlsx') || 
                              file.name.endsWith('.xls') || 
                              file.name.endsWith('.csv') ||
                              file.type.includes('spreadsheet') ||
                              file.type.includes('excel') ||
                              file.type.includes('csv');
                
                if (isValid) {
                    console.log('‚úÖ Valid file, adding to', type + 's');
                    
                    // Asegurar que la estructura existe
                    if (!currentMonth.files[type + 's']) {
                        currentMonth.files[type + 's'] = [];
                        console.log('üìÅ Created array for', type + 's');
                    }
                    
                    currentMonth.files[type + 's'].push({
                        name: file.name,
                        file: file,
                        uploadTime: new Date().toISOString(),
                        type: type
                    });
                    validFiles++;
                    console.log('üìä File added successfully. Total files:', currentMonth.files[type + 's'].length);
                } else {
                    console.log('‚ùå Invalid file type:', file.name, file.type);
                }
            }
            
            console.log('üéØ Processing complete. Valid files:', validFiles);
            
            // Actualizar interfaz
            updateMonthStructure();
            
            // Mostrar resultado
            if (validFiles > 0) {
                const message = `‚úÖ ${validFiles} archivo(s) a√±adido(s) a ${type === 'export' ? 'Exportaciones' : 'Importaciones'}`;
                console.log('üì¢', message);
                alert(message); // Usar alert simple por ahora
            } else {
                const message = '‚ùå No se encontraron archivos v√°lidos (Excel o CSV)';
                console.log('üì¢', message);
                alert(message);
            }
        }

        function handleClassifiedDrop(event, type) {
            event.preventDefault();
            event.stopPropagation();
            
            const zone = event.currentTarget;
            zone.classList.remove('dragover');
            
            const files = event.dataTransfer.files;
            handleClassifiedFiles(files, type);
        }

        // Procesamiento del mes completo
        async function processCurrentMonth() {
            const totalFiles = currentMonth.files.exports.length + currentMonth.files.imports.length;
            
            if (totalFiles === 0) {
                showAlert('No hay archivos para procesar', 'error');
                return;
            }

            showMonthProgress(true);
            showMonthLog(true);
            
            logMonth('üöÄ Iniciando procesamiento del mes completo...');
            logMonth(`üìÖ Per√≠odo: ${document.getElementById('folder-title').textContent}`);
            logMonth(`üìä Total archivos: ${totalFiles} (${currentMonth.files.exports.length} exp, ${currentMonth.files.imports.length} imp)`);

            let progress = 0;
            const increment = 100 / totalFiles;

            try {
                // Procesar exportaciones
                if (currentMonth.files.exports.length > 0) {
                    logMonth('üì§ Procesando exportaciones...');
                    for (let i = 0; i < currentMonth.files.exports.length; i++) {
                        const file = currentMonth.files.exports[i];
                        logMonth(`  üìÑ Procesando: ${file.name}`);
                        
                        const data = await processExcelFile(file.file);
                        if (data && data.length > 0) {
                            processedData.exports.push({
                                fileName: file.name,
                                uploadTime: file.uploadTime,
                                data: data,
                                month: currentMonth.month,
                                year: currentMonth.year
                            });
                            logMonth(`  ‚úÖ ${data.length} registros procesados`);
                        }
                        
                        progress += increment;
                        updateMonthProgress(progress, `Procesando ${file.name}...`);
                        await sleep(100);
                    }
                }

                // Procesar importaciones
                if (currentMonth.files.imports.length > 0) {
                    logMonth('üì• Procesando importaciones...');
                    for (let i = 0; i < currentMonth.files.imports.length; i++) {
                        const file = currentMonth.files.imports[i];
                        logMonth(`  üìÑ Procesando: ${file.name}`);
                        
                        const data = await processExcelFile(file.file);
                        if (data && data.length > 0) {
                            processedData.imports.push({
                                fileName: file.name,
                                uploadTime: file.uploadTime,
                                data: data,
                                month: currentMonth.month,
                                year: currentMonth.year
                            });
                            logMonth(`  ‚úÖ ${data.length} registros procesados`);
                        }
                        
                        progress += increment;
                        updateMonthProgress(progress, `Procesando ${file.name}...`);
                        await sleep(100);
                    }
                }

                // Consolidar datos
                updateMonthProgress(95, 'Consolidando datos...');
                logMonth('üîÑ Consolidando datos del mes...');
                
                consolidateMonthData();
                updateAllTabs();
                
                updateMonthProgress(100, '¬°Procesamiento completado!');
                logMonth('‚úÖ Procesamiento del mes completado exitosamente');
                
                showAlert('Mes procesado exitosamente. Revisa las pesta√±as de Exportaciones, Importaciones y Resumen.', 'success');
                
            } catch (error) {
                logMonth(`‚ùå Error durante el procesamiento: ${error.message}`);
                showAlert('Error durante el procesamiento: ' + error.message, 'error');
            }
        }

        function consolidateMonthData() {
            // Consolidar exportaciones
            const exportsByCountry = {};
            processedData.exports.forEach(fileData => {
                fileData.data.forEach(row => {
                    const country = row['Pa√≠s de destino'] || row['Pa√≠s'] || 'DESCONOCIDO';
                    if (!exportsByCountry[country]) {
                        exportsByCountry[country] = {
                            country: country,
                            totalValue: 0,
                            totalWeight: 0,
                            records: [],
                            sourceFiles: new Set()
                        };
                    }
                    
                    const value = parseFloat(row['Importe facturado'] || row['Valor'] || 0);
                    const weight = parseFloat(row['Masa neta (kg)'] || row['Peso'] || 0);
                    
                    exportsByCountry[country].totalValue += Math.abs(value);
                    exportsByCountry[country].totalWeight += Math.abs(weight);
                    exportsByCountry[country].records.push({
                        ...row,
                        sourceFile: fileData.fileName,
                        uploadTime: fileData.uploadTime
                    });
                    exportsByCountry[country].sourceFiles.add(fileData.fileName);
                });
            });

            // Consolidar importaciones
            const importsByCountry = {};
            processedData.imports.forEach(fileData => {
                fileData.data.forEach(row => {
                    const country = row['Pa√≠s de origen'] || row['Pa√≠s'] || 'DESCONOCIDO';
                    if (!importsByCountry[country]) {
                        importsByCountry[country] = {
                            country: country,
                            totalValue: 0,
                            totalWeight: 0,
                            records: [],
                            sourceFiles: new Set()
                        };
                    }
                    
                    const value = parseFloat(row['Importe facturado'] || row['Valor'] || 0);
                    const weight = parseFloat(row['Masa neta (kg)'] || row['Peso'] || 0);
                    
                    importsByCountry[country].totalValue += Math.abs(value);
                    importsByCountry[country].totalWeight += Math.abs(weight);
                    importsByCountry[country].records.push({
                        ...row,
                        sourceFile: fileData.fileName,
                        uploadTime: fileData.uploadTime
                    });
                    importsByCountry[country].sourceFiles.add(fileData.fileName);
                });
            });

            processedData.consolidatedExports = Object.values(exportsByCountry);
            processedData.consolidatedImports = Object.values(importsByCountry);
        }

        // Funciones de progreso y log para meses
        function showMonthProgress(show) {
            document.getElementById('month-progress-section').style.display = show ? 'block' : 'none';
        }

        function updateMonthProgress(percentage, text) {
            document.getElementById('month-progress-fill').style.width = percentage + '%';
            document.getElementById('month-progress-text').textContent = text;
        }

        function showMonthLog(show) {
            document.getElementById('month-log-section').style.display = show ? 'block' : 'none';
        }

        function logMonth(message) {
            const logArea = document.getElementById('month-log-area');
            const timestamp = new Date().toLocaleTimeString();
            logArea.innerHTML += `[${timestamp}] ${message}\n`;
            logArea.scrollTop = logArea.scrollHeight;
        }

        // Procesador r√°pido (legacy)
        function handleFiles(files) {
            const fileItems = document.getElementById('fileItems');
            fileItems.innerHTML = '';
            
            Array.from(files).forEach((file, index) => {
                if (file.type.includes('sheet') || file.name.endsWith('.xlsx') || file.name.endsWith('.xls') || file.name.endsWith('.csv')) {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.innerHTML = `
                        <div class="file-info">
                            <div class="file-name">üìÑ ${file.name}</div>
                            <div class="file-details">Tama√±o: ${(file.size / 1024).toFixed(1)} KB | Tipo: ${file.type || 'Desconocido'}</div>
                        </div>
                        <button class="btn btn-danger" onclick="removeFile(${index})">‚ùå Quitar</button>
                    `;
                    fileItems.appendChild(fileItem);
                }
            });
            
            if (fileItems.children.length > 0) {
                document.getElementById('fileList').style.display = 'block';
            }
        }

        function removeFile(index) {
            const fileItems = document.getElementById('fileItems');
            fileItems.removeChild(fileItems.children[index]);
            
            if (fileItems.children.length === 0) {
                document.getElementById('fileList').style.display = 'none';
            }
        }

        async function processFiles() {
            const fileItems = document.getElementById('fileItems');
            const files = Array.from(fileItems.children).map(item => {
                const fileName = item.querySelector('.file-name').textContent.replace('üìÑ ', '');
                return document.getElementById('fileInput').files[Array.from(document.getElementById('fileInput').files).findIndex(f => f.name === fileName)];
            });

            if (files.length === 0) {
                showAlert('No hay archivos para procesar', 'error');
                return;
            }

            showProgress(true);
            showLog(true);
            
            log('üöÄ Iniciando procesamiento de archivos...');
            
            let progress = 0;
            const increment = 100 / files.length;

            try {
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    log(`üìÑ Procesando archivo: ${file.name}`);
                    
                    updateProgress(progress, `Procesando ${file.name}...`);
                    
                    const data = await processExcelFile(file);
                    
                    if (data && data.length > 0) {
                        // Detectar tipo de archivo basado en las columnas
                        const isExport = detectFileType(data) === 'export';
                        
                        if (isExport) {
                            processedData.exports.push({
                                fileName: file.name,
                                uploadTime: new Date().toISOString(),
                                data: data
                            });
                            log(`‚úÖ Procesado como EXPORTACI√ìN: ${data.length} registros`);
                        } else {
                            processedData.imports.push({
                                fileName: file.name,
                                uploadTime: new Date().toISOString(),
                                data: data
                            });
                            log(`‚úÖ Procesado como IMPORTACI√ìN: ${data.length} registros`);
                        }
                    }
                    
                    progress += increment;
                    await sleep(100);
                }

                updateProgress(95, 'Consolidando datos...');
                log('üîÑ Consolidando datos...');
                
                consolidateData();
                updateAllTabs();
                
                updateProgress(100, '¬°Procesamiento completado!');
                log('‚úÖ Procesamiento completado exitosamente');
                
                showAlert('Archivos procesados exitosamente. Revisa las pesta√±as de Exportaciones, Importaciones y Resumen.', 'success');
                
            } catch (error) {
                log(`‚ùå Error durante el procesamiento: ${error.message}`);
                showAlert('Error durante el procesamiento: ' + error.message, 'error');
            }
        }

        // Funciones de procesamiento de archivos
        function processExcelFile(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            try {
                let rawData;
                
                if (file.name.endsWith('.csv')) {
                    rawData = parseCSV(e.target.result);
                } else {
                    const workbook = XLSX.read(e.target.result, { type: 'binary' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    rawData = XLSX.utils.sheet_to_json(firstSheet);
                }
                
                // Mapear datos al formato AEAT
                const aeatData = rawData.map(row => {
                    // Detectar pa√≠s (buscar c√≥digos de 2 letras)
                    const country = detectCountry(row);
                    
                    // Detectar c√≥digo de mercanc√≠a (8 d√≠gitos)
                    const mercancyCode = detectMercancyCode(row);
                    
                    // Detectar valores monetarios
                    const amount = detectAmount(row);
                    
                    // Detectar peso
                    const weight = detectWeight(row);
                    
                    // Detectar NIF de contraparte
                    const nif = detectNIF(row);
                    
                    return {
                        estadoMiembro: country || 'FR', // Pa√≠s destino/origen
                        provincia: '48', // Bizkaia por defecto
                        condiciones: 'FCA', // Por defecto
                        naturaleza: '11', // Por defecto
                        transporte: '3', // Por defecto
                        puerto: '', // Vac√≠o por defecto
                        codigoMercancia: mercancyCode || '85044095',
                        paisOrigen: 'ES', // Espa√±a por defecto para exports
                        regimen: '', // Vac√≠o por defecto
                        masaNeta: weight || 0,
                        unidadesSuplementarias: '', // Vac√≠o por defecto
                        importeFacturado: amount || 0,
                        valorEstadistico: amount || 0,
                        nifContraparte: nif || '',
                        
                        // Campos adicionales para trazabilidad
                        archivoOrigen: file.name,
                        datosOriginales: row
                    };
                });
                
                resolve(aeatData);
            } catch (error) {
                reject(new Error(`Error procesando ${file.name}: ${error.message}`));
            }
        };
        
        reader.onerror = () => reject(new Error(`Error leyendo el archivo ${file.name}`));
        
        if (file.name.endsWith('.csv')) {
            reader.readAsText(file);
        } else {
            reader.readAsBinaryString(file);
        }
    });
}

// Funciones auxiliares de detecci√≥n
function detectCountry(row) {
    const keys = Object.keys(row);
    for (let key of keys) {
        const value = String(row[key]).toUpperCase();
        if (/^[A-Z]{2}$/.test(value) && ['FR', 'DE', 'IT', 'PT', 'BE', 'NL', 'AT'].includes(value)) {
            return value;
        }
    }
    return null;
}

function detectMercancyCode(row) {
    const keys = Object.keys(row);
    for (let key of keys) {
        const value = String(row[key]).replace(/\D/g, '');
        if (value.length === 8) {
            return value;
        }
    }
    return null;
}

function detectAmount(row) {
    const keys = Object.keys(row);
    for (let key of keys) {
        if (key.toLowerCase().includes('importe') || 
            key.toLowerCase().includes('valor') ||
            key.toLowerCase().includes('precio')) {
            const value = parseFloat(String(row[key]).replace(/[^\d,.-]/g, '').replace(',', '.'));
            if (!isNaN(value) && value > 0) {
                return Math.abs(value);
            }
        }
    }
    return 0;
}

function detectWeight(row) {
    const keys = Object.keys(row);
    for (let key of keys) {
        if (key.toLowerCase().includes('peso') || 
            key.toLowerCase().includes('masa') ||
            key.toLowerCase().includes('kg')) {
            const value = parseFloat(String(row[key]).replace(/[^\d,.-]/g, '').replace(',', '.'));
            if (!isNaN(value) && value > 0) {
                return value;
            }
        }
    }
    return 0;
}

function detectNIF(row) {
    const keys = Object.keys(row);
    for (let key of keys) {
        if (key.toLowerCase().includes('nif') || 
            key.toLowerCase().includes('vat') ||
            key.toLowerCase().includes('tax')) {
            const value = String(row[key]).trim();
            if (value.length > 5) {
                return value;
            }
        }
    }
    return '';
}

        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            const headers = lines[0].split(';').map(h => h.trim());
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim()) {
                    const values = lines[i].split(';');
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index] ? values[index].trim() : '';
                    });
                    data.push(row);
                }
            }
            
            return data;
        }

        function detectFileType(data) {
            if (data.length === 0) return 'unknown';
            
            const firstRow = data[0];
            const columns = Object.keys(firstRow).map(k => k.toLowerCase());
            
            // Buscar indicadores de exportaci√≥n
            const exportIndicators = ['destino', 'expedici√≥n', 'exportaci√≥n', 'cliente'];
            const importIndicators = ['origen', 'adquisici√≥n', 'importaci√≥n', 'proveedor'];
            
            const hasExportIndicators = exportIndicators.some(indicator => 
                columns.some(col => col.includes(indicator))
            );
            
            const hasImportIndicators = importIndicators.some(indicator => 
                columns.some(col => col.includes(indicator))
            );
            
            if (hasExportIndicators && !hasImportIndicators) return 'export';
            if (hasImportIndicators && !hasExportIndicators) return 'import';
            
            // Si no est√° claro, usar heur√≠stica por defecto
            return 'export';
        }

        function consolidateData() {
            // Consolidar exportaciones
            const exportsByCountry = {};
            processedData.exports.forEach(fileData => {
                fileData.data.forEach(row => {
                    const country = row['Pa√≠s de destino'] || row['Pa√≠s'] || 'DESCONOCIDO';
                    if (!exportsByCountry[country]) {
                        exportsByCountry[country] = {
                            country: country,
                            totalValue: 0,
                            totalWeight: 0,
                            records: []
                        };
                    }
                    
                    const value = parseFloat(row['Importe facturado'] || row['Valor'] || 0);
                    const weight = parseFloat(row['Masa neta (kg)'] || row['Peso'] || 0);
                    
                    exportsByCountry[country].totalValue += Math.abs(value);
                    exportsByCountry[country].totalWeight += Math.abs(weight);
                    exportsByCountry[country].records.push(row);
                });
            });

            // Consolidar importaciones
            const importsByCountry = {};
            processedData.imports.forEach(fileData => {
                fileData.data.forEach(row => {
                    const country = row['Pa√≠s de origen'] || row['Pa√≠s'] || 'DESCONOCIDO';
                    if (!importsByCountry[country]) {
                        importsByCountry[country] = {
                            country: country,
                            totalValue: 0,
                            totalWeight: 0,
                            records: []
                        };
                    }
                    
                    const value = parseFloat(row['Importe facturado'] || row['Valor'] || 0);
                    const weight = parseFloat(row['Masa neta (kg)'] || row['Peso'] || 0);
                    
                    importsByCountry[country].totalValue += Math.abs(value);
                    importsByCountry[country].totalWeight += Math.abs(weight);
                    importsByCountry[country].records.push(row);
                });
            });

            processedData.consolidatedExports = Object.values(exportsByCountry);
            processedData.consolidatedImports = Object.values(importsByCountry);
        }

        // Actualizaci√≥n de pesta√±as
        function updateAllTabs() {
            updateExportsTab();
            updateImportsTab();
            updateSummaryTab();
        }

        function updateExportsTab() {
            const container = document.getElementById('exportData');
            
            if (processedData.consolidatedExports.length === 0) {
                container.innerHTML = '<p>No se han procesado exportaciones a√∫n.</p>';
                return;
            }

            let html = `
                <div class="summary-grid">
                    <div class="summary-card">
                        <h3>üì§ Total Exportaciones</h3>
                        <div class="summary-value">${processedData.consolidatedExports.length}</div>
                        <div class="summary-label">pa√≠ses destino</div>
                    </div>
                    <div class="summary-card">
                        <h3>üí∞ Valor Total</h3>
                        <div class="summary-value">‚Ç¨${processedData.consolidatedExports.reduce((sum, exp) => sum + exp.totalValue, 0).toLocaleString()}</div>
                        <div class="summary-label">importe facturado</div>
                    </div>
                    <div class="summary-card">
                        <h3>‚öñÔ∏è Peso Total</h3>
                        <div class="summary-value">${(processedData.consolidatedExports.reduce((sum, exp) => sum + exp.totalWeight, 0) / 1000).toFixed(1)}</div>
                        <div class="summary-label">toneladas</div>
                    </div>
                </div>
                
                <div class="country-breakdown">
            `;

            processedData.consolidatedExports
                .sort((a, b) => b.totalValue - a.totalValue)
                .forEach(countryData => {
                    html += `
                        <div class="country-card">
                            <h4>üá™üá∫ ${countryData.country}</h4>
                            <p><strong>Valor:</strong> ‚Ç¨${countryData.totalValue.toLocaleString()}</p>
                            <p><strong>Peso:</strong> ${(countryData.totalWeight / 1000).toFixed(1)} t</p>
                            <p><strong>Registros:</strong> ${countryData.records.length}</p>
                            ${countryData.sourceFiles ? `<p><strong>Archivos:</strong> ${Array.from(countryData.sourceFiles).join(', ')}</p>` : ''}
                        </div>
                    `;
                });

            html += '</div>';

            // Bot√≥n de exportaci√≥n
            html += `
                <div class="export-section">
                    <h3>üìÅ Exportar Datos</h3>
                    <button class="btn btn-success btn-large" onclick="exportToExcel('exports')">
                        üìä Descargar Excel de Exportaciones
                    </button>
                </div>
            `;

            container.innerHTML = html;
        }

        function updateImportsTab() {
            const container = document.getElementById('importData');
            
            if (processedData.consolidatedImports.length === 0) {
                container.innerHTML = '<p>No se han procesado importaciones a√∫n.</p>';
                return;
            }

            let html = `
                <div class="summary-grid">
                    <div class="summary-card">
                        <h3>üì• Total Importaciones</h3>
                        <div class="summary-value">${processedData.consolidatedImports.length}</div>
                        <div class="summary-label">pa√≠ses origen</div>
                    </div>
                    <div class="summary-card">
                        <h3>üí∞ Valor Total</h3>
                        <div class="summary-value">‚Ç¨${processedData.consolidatedImports.reduce((sum, imp) => sum + imp.totalValue, 0).toLocaleString()}</div>
                        <div class="summary-label">importe facturado</div>
                    </div>
                    <div class="summary-card">
                        <h3>‚öñÔ∏è Peso Total</h3>
                        <div class="summary-value">${(processedData.consolidatedImports.reduce((sum, imp) => sum + imp.totalWeight, 0) / 1000).toFixed(1)}</div>
                        <div class="summary-label">toneladas</div>
                    </div>
                </div>
                
                <div class="country-breakdown">
            `;

            processedData.consolidatedImports
                .sort((a, b) => b.totalValue - a.totalValue)
                .forEach(countryData => {
                    html += `
                        <div class="country-card" style="border-left-color: #27ae60;">
                            <h4>üá™üá∫ ${countryData.country}</h4>
                            <p><strong>Valor:</strong> ‚Ç¨${countryData.totalValue.toLocaleString()}</p>
                            <p><strong>Peso:</strong> ${(countryData.totalWeight / 1000).toFixed(1)} t</p>
                            <p><strong>Registros:</strong> ${countryData.records.length}</p>
                            ${countryData.sourceFiles ? `<p><strong>Archivos:</strong> ${Array.from(countryData.sourceFiles).join(', ')}</p>` : ''}
                        </div>
                    `;
                });

            html += '</div>';

            // Bot√≥n de exportaci√≥n
            html += `
                <div class="export-section">
                    <h3>üìÅ Exportar Datos</h3>
                    <button class="btn btn-success btn-large" onclick="exportToExcel('imports')">
                        üìä Descargar Excel de Importaciones
                    </button>
                </div>
            `;

            container.innerHTML = html;
        }

        function updateSummaryTab() {
            const container = document.getElementById('summaryContent');
            
            if (processedData.consolidatedExports.length === 0 && processedData.consolidatedImports.length === 0) {
                container.innerHTML = '<p>Procesa archivos para ver el resumen completo.</p>';
                return;
            }

            const totalExportValue = processedData.consolidatedExports.reduce((sum, exp) => sum + exp.totalValue, 0);
            const totalImportValue = processedData.consolidatedImports.reduce((sum, imp) => sum + imp.totalValue, 0);
            const totalExportWeight = processedData.consolidatedExports.reduce((sum, exp) => sum + exp.totalWeight, 0);
            const totalImportWeight = processedData.consolidatedImports.reduce((sum, imp) => sum + imp.totalWeight, 0);

            let html = `
                <div class="summary-grid">
                    <div class="summary-card">
                        <h3>üìä Balance Comercial</h3>
                        <div class="summary-value ${totalExportValue - totalImportValue >= 0 ? 'style="color: #27ae60;"' : 'style="color: #e74c3c;"'}"}>
                            ‚Ç¨${(totalExportValue - totalImportValue).toLocaleString()}
                        </div>
                        <div class="summary-label">${totalExportValue - totalImportValue >= 0 ? 'super√°vit' : 'd√©ficit'}</div>
                    </div>
                    <div class="summary-card">
                        <h3>üì§ Exportaciones</h3>
                        <div class="summary-value">‚Ç¨${totalExportValue.toLocaleString()}</div>
                        <div class="summary-label">${processedData.consolidatedExports.length} pa√≠ses</div>
                    </div>
                    <div class="summary-card">
                        <h3>üì• Importaciones</h3>
                        <div class="summary-value">‚Ç¨${totalImportValue.toLocaleString()}</div>
                        <div class="summary-label">${processedData.consolidatedImports.length} pa√≠ses</div>
                    </div>
                    <div class="summary-card">
                        <h3>‚öñÔ∏è Peso Total</h3>
                        <div class="summary-value">${((totalExportWeight + totalImportWeight) / 1000).toFixed(1)}</div>
                        <div class="summary-label">toneladas</div>
                    </div>
                </div>

                <div class="export-section">
                    <h3>üìÅ Archivos Consolidados AEAT</h3>
                    <p>Descarga los archivos finales para presentar a la AEAT:</p>
                    <button class="btn btn-success btn-large" onclick="exportConsolidated()">
                        üìã Descargar Consolidado Completo
                    </button>
                </div>

                <div style="background: #f8f9fa; border-radius: 10px; padding: 20px; margin-top: 20px;">
                    <h3>üìã Archivos Procesados:</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <h4 style="color: #27ae60;">üì§ Exportaciones:</h4>
                            <ul style="margin-left: 20px;">
                                ${processedData.exports.map(file => `
                                    <li>${file.fileName} 
                                        ${file.month && file.year ? `<small>(${file.month}/${file.year})</small>` : ''}
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                        <div>
                            <h4 style="color: #e74c3c;">üì• Importaciones:</h4>
                            <ul style="margin-left: 20px;">
                                ${processedData.imports.map(file => `
                                    <li>${file.fileName}
                                        ${file.month && file.year ? `<small>(${file.month}/${file.year})</small>` : ''}
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        // Funciones de exportaci√≥n
        function exportToExcel(type) {
    const data = type === 'exports' ? processedData.consolidatedExports : processedData.consolidatedImports;
    
    if (data.length === 0) {
        showAlert('No hay datos para exportar', 'error');
        return;
    }

    // Generar CSV formato AEAT
    let csvContent = '';
    
    data.forEach(country => {
        country.records.forEach(record => {
            // Formato AEAT: Estado miembro;Provincia;Condiciones;Naturaleza;Transporte;Puerto;C√≥digo;Pa√≠s origen;R√©gimen;Masa;Unidades;Importe;Valor;NIF
            const line = [
                record.estadoMiembro || 'FR',
                record.provincia || '48',
                record.condiciones || 'FCA',
                record.naturaleza || '11',
                record.transporte || '3',
                record.puerto || '',
                record.codigoMercancia || '85044095',
                record.paisOrigen || 'ES',
                record.regimen || '',
                record.masaNeta || '',
                record.unidadesSuplementarias || '',
                String(record.importeFacturado || 0).replace('.', ','),
                String(record.valorEstadistico || record.importeFacturado || 0).replace('.', ','),
                record.nifContraparte || ''
            ].join(';');
            
            csvContent += line + '\n';
        });
    });

    // Crear y descargar archivo CSV
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `AEAT_${type === 'exports' ? 'Exportaciones' : 'Importaciones'}_${new Date().toISOString().slice(0,10)}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showAlert(`Archivo CSV AEAT descargado exitosamente`, 'success');
}

        function exportConsolidated() {
    if (processedData.consolidatedExports.length === 0 && processedData.consolidatedImports.length === 0) {
        showAlert('No hay datos procesados para exportar', 'error');
        return;
    }

    // Generar archivo consolidado con ambos tipos
    let csvContent = '';
    
    // Exportaciones
    processedData.consolidatedExports.forEach(country => {
        country.records.forEach(record => {
            const line = [
                record.estadoMiembro || 'FR',
                record.provincia || '48',
                record.condiciones || 'FCA',
                record.naturaleza || '11',
                record.transporte || '3',
                record.puerto || '',
                record.codigoMercancia || '85044095',
                record.paisOrigen || 'ES',
                record.regimen || '',
                record.masaNeta || '',
                record.unidadesSuplementarias || '',
                String(record.importeFacturado || 0).replace('.', ','),
                String(record.valorEstadistico || record.importeFacturado || 0).replace('.', ','),
                record.nifContraparte || ''
            ].join(';');
            csvContent += line + '\n';
        });
    });
    
    // Importaciones  
    processedData.consolidatedImports.forEach(country => {
        country.records.forEach(record => {
            const line = [
                record.estadoMiembro || 'FR',
                record.provincia || '48',
                record.condiciones || 'FCA',
                record.naturaleza || '11',
                record.transporte || '3',
                record.puerto || '',
                record.codigoMercancia || '85044095',
                record.paisOrigen || (record.estadoMiembro || 'FR'), // Para imports, pa√≠s origen es el de la contraparte
                record.regimen || '',
                record.masaNeta || '',
                record.unidadesSuplementarias || '',
                String(record.importeFacturado || 0).replace('.', ','),
                String(record.valorEstadistico || record.importeFacturado || 0).replace('.', ','),
                record.nifContraparte || ''
            ].join(';');
            csvContent += line + '\n';
        });
    });

    // Descargar archivo consolidado
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `AEAT_Consolidado_Intrastat_${new Date().toISOString().slice(0,10)}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showAlert(`Archivo CSV consolidado AEAT descargado exitosamente`, 'success');
}

        // Funciones de utilidad
        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('dragover');
        }

        function handleDrop(event) {
            event.preventDefault();
            event.stopPropagation();
            
            const area = event.currentTarget;
            area.classList.remove('dragover');
            
            const files = event.dataTransfer.files;
            handleFiles(files);
        }

        function showProgress(show) {
            document.getElementById('progressSection').style.display = show ? 'block' : 'none';
        }

        function updateProgress(percentage, text) {
            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('progressText').textContent = text;
        }

        function showLog(show) {
            document.getElementById('logSection').style.display = show ? 'block' : 'none';
        }

        function log(message) {
            const logArea = document.getElementById('logArea');
            const timestamp = new Date().toLocaleTimeString();
            logArea.innerHTML += `[${timestamp}] ${message}\n`;
            logArea.scrollTop = logArea.scrollHeight;
        }

        function showAlert(message, type) {
            try {
                console.log('showAlert called with:', message, type);
                
                // Crear elemento de alerta
                const alert = document.createElement('div');
                alert.className = `alert alert-${type}`;
                alert.innerHTML = `
                    <strong>${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}</strong> ${message}
                    <button onclick="this.parentElement.remove()" style="float: right; background: none; border: none; font-size: 1.2em; cursor: pointer;">√ó</button>
                `;
                
                // Insertar al principio del contenido principal
                const mainContent = document.querySelector('.main-content');
                if (mainContent) {
                    mainContent.insertBefore(alert, mainContent.firstChild);
                    console.log('Alert inserted successfully');
                } else {
                    console.error('Main content not found');
                    // Fallback: insertar en body
                    document.body.appendChild(alert);
                }
                
                // Auto-remover despu√©s de 5 segundos
                setTimeout(() => {
                    if (alert.parentElement) {
                        alert.remove();
                        console.log('Alert auto-removed');
                    }
                }, 5000);
            } catch (error) {
                console.error('Error in showAlert:', error);
                // Fallback simple
                window.alert(message);
            }
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Event listeners globales para drag and drop
        document.addEventListener('dragover', function(e) {
            e.preventDefault();
        });

        document.addEventListener('drop', function(e) {
            e.preventDefault();
        });
    </script>
</body>
</html>
