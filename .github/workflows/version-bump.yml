name: üè∑Ô∏è Auto Version Bump

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options:
        - patch
        - minor
        - major
  push:
    branches: [ main ]
    paths-ignore:
      - '.github/**'
      - 'README.md'

jobs:
  version-bump:
    runs-on: ubuntu-latest
    if: ${{ !contains(github.event.head_commit.message, 'Bump version to') }}
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: üî¢ Bump version
      id: bump
      run: |
        echo "=== Starting version bump process ==="
        
        # Verificar que los archivos existen
        if [ ! -f "Index.html" ]; then
          echo "ERROR: Index.html not found"
          exit 1
        fi
        
        if [ ! -f "package.json" ]; then
          echo "ERROR: package.json not found"
          exit 1
        fi
        
        # Extraer versi√≥n actual del package.json (m√°s confiable)
        CURRENT=$(grep -o '"version": "[^"]*"' package.json | sed 's/"version": "//' | sed 's/"//')
        echo "Current version from package.json: $CURRENT"
        
        # Verificar que la versi√≥n tiene formato correcto
        if [[ ! $CURRENT =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
          echo "ERROR: Invalid version format: $CURRENT"
          exit 1
        fi
        
        # Separar componentes de la versi√≥n
        IFS='.' read -r major minor patch <<< "$CURRENT"
        echo "Parsed - Major: $major, Minor: $minor, Patch: $patch"
        
        # Incrementar patch por defecto
        NEW_PATCH=$((patch + 1))
        NEW_VERSION="$major.$minor.$NEW_PATCH"
        
        echo "New version: $NEW_VERSION"
        
        # Verificar que la nueva versi√≥n es diferente
        if [ "$CURRENT" = "$NEW_VERSION" ]; then
          echo "ERROR: New version same as current"
          exit 1
        fi
        
        # Actualizar package.json
        echo "Updating package.json..."
        sed -i "s/\"version\": \"$CURRENT\"/\"version\": \"$NEW_VERSION\"/" package.json
        
        # Actualizar Index.html - versi√≥n en header
        echo "Updating Index.html header..."
        sed -i "s/app-version\">$CURRENT</app-version\">$NEW_VERSION</" Index.html
        
        # Actualizar Index.html - versi√≥n en metadatos
        echo "Updating Index.html metadata..."
        sed -i "s/'Versi√≥n del Sistema': '$CURRENT'/'Versi√≥n del Sistema': '$NEW_VERSION'/" Index.html
        
        # Verificar que los cambios se aplicaron
        NEW_PKG_VERSION=$(grep -o '"version": "[^"]*"' package.json | sed 's/"version": "//' | sed 's/"//')
        NEW_HTML_VERSION=$(grep -o 'app-version">[^<]*' Index.html | sed 's/app-version">//')
        
        echo "Verification:"
        echo "  package.json version: $NEW_PKG_VERSION"
        echo "  Index.html version: $NEW_HTML_VERSION"
        
        if [ "$NEW_PKG_VERSION" != "$NEW_VERSION" ] || [ "$NEW_HTML_VERSION" != "$NEW_VERSION" ]; then
          echo "ERROR: Version update failed"
          exit 1
        fi
        
        echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
        echo "=== Version bump completed successfully ==="
        
    - name: üíæ Commit version bump
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add Index.html package.json
        git commit -m "Bump version to ${{ steps.bump.outputs.version }}" || exit 0
        git push
