name: 🚀 Deploy to Railway

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v4
      
    - name: 🏷️ Extract version from index.html
      id: version
      run: |
        VERSION=$(grep -o 'app-version">[^<]*' index.html | sed 's/app-version">//')
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "🏷️ Detected version: $VERSION"
        
    - name: 📊 Create deployment status
      run: |
        echo "🚀 Deploying version ${{ steps.version.outputs.version }} to Railway..."
        echo "📁 Files changed in this commit:"
        git diff --name-only HEAD~1 HEAD || echo "Initial commit"
        
    - name: 🌐 Trigger Railway deployment
      run: |
        echo "✅ Railway will auto-deploy from this push"
        echo "🔗 App URL: https://intrastat-manager-alstom-production.up.railway.app/"
        
    - name: 📋 Create deployment summary
      run: |
        echo "## 🚀 Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Version**: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Railway URL**: https://intrastat-manager-alstom-production.up.railway.app/" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: ✅ Deployed successfully" >> $GITHUB_STEP_SUMMARY

  notify:
    needs: deploy
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: 📢 Deployment notification
      run: |
        if [ "${{ needs.deploy.result }}" == "success" ]; then
          echo "🎉 Deployment completed successfully!"
        else
          echo "❌ Deployment failed!"
        fi
