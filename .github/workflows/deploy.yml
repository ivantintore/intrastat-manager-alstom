name: ğŸš€ Deploy to Railway

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ·ï¸ Extract version from index.html
      id: version
      run: |
        VERSION=$(grep -o 'app-version">[^<]*' index.html | sed 's/app-version">//')
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "ğŸ·ï¸ Detected version: $VERSION"
        
    - name: ğŸ“Š Create deployment status
      run: |
        echo "ğŸš€ Deploying version ${{ steps.version.outputs.version }} to Railway..."
        echo "ğŸ“ Files changed in this commit:"
        git diff --name-only HEAD~1 HEAD || echo "Initial commit"
        
    - name: ğŸŒ Trigger Railway deployment
      run: |
        echo "âœ… Railway will auto-deploy from this push"
        echo "ğŸ”— App URL: https://intrastat-manager-alstom-production.up.railway.app/"
        
    - name: ğŸ“‹ Create deployment summary
      run: |
        echo "## ğŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Version**: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Railway URL**: https://intrastat-manager-alstom-production.up.railway.app/" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: âœ… Deployed successfully" >> $GITHUB_STEP_SUMMARY

  notify:
    needs: deploy
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ğŸ“¢ Deployment notification
      run: |
        if [ "${{ needs.deploy.result }}" == "success" ]; then
          echo "ğŸ‰ Deployment completed successfully!"
        else
          echo "âŒ Deployment failed!"
        fi
